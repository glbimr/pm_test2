<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus PM System - Admin & Member Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase Client Library with fallback -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js" 
            onerror="this.onerror=null; this.src='https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js';"></script>
    
    <!-- Initialize Supabase after library loads -->
    <script>
        // Wait for Supabase to be available
        window.supabaseClient = null;
        (function initSupabaseClient() {
            const SUPABASE_URL = 'https://ptcejmgkctinjzvvpudf.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0Y2VqbWdrY3Rpbmp6dnZwdWRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MDcwOTIsImV4cCI6MjA3OTI4MzA5Mn0.aNwE0o6u7uHfwlf0uYtGSnYeNPKNWt6MliezIGYjHPQ';
            
            function tryInit() {
                // Check for supabase in different possible locations (UMD build)
                let supabaseLib = null;
                if (typeof window.supabase !== 'undefined' && window.supabase) {
                    // UMD build exposes it as window.supabase or window.supabase.default
                    supabaseLib = window.supabase.default || window.supabase;
                }
                
                if (supabaseLib && typeof supabaseLib.createClient === 'function') {
                    try {
                        window.supabaseClient = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        console.log('‚úÖ Supabase client initialized in pre-script');
                        return true;
                    } catch (error) {
                        console.error('‚ùå Error initializing Supabase in pre-script:', error);
                        return false;
                    }
                }
                return false;
            }
            
            // Try immediately
            if (!tryInit()) {
                // Retry every 100ms for up to 3 seconds
                let attempts = 0;
                const interval = setInterval(() => {
                    attempts++;
                    if (tryInit() || attempts >= 30) {
                        clearInterval(interval);
                        if (!window.supabaseClient) {
                            console.warn('‚ö†Ô∏è Supabase library not loaded. App will work in offline mode.');
                        }
                    }
                }, 100);
            }
        })();
    </script>

    <style>
        /* Custom Scrollbar for nicer UI */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        /* Responsive helpers */
        .responsive-sidebar { width: 16rem; }
        .responsive-chat-left { width: 20rem; }
        .kanban-column { min-width: 20rem; }

        /* Bottom nav placeholder spacing for small screens */
        .pb-safe { padding-bottom: 4rem; }

        @media (max-width: 1024px) {
            /* iPad / small laptop */
            .responsive-sidebar { width: 4.5rem !important; }
            .responsive-chat-left { width: 5.5rem !important; }
            .kanban-column { min-width: 16rem !important; }
            main { padding: 1rem; }
        }

        /* Tablet / Nest Hub adjustments (roughly iPad / smart display sizes) */
        @media (min-width: 641px) and (max-width: 1024px) {
            .responsive-sidebar { width: 5.5rem !important; }
            .responsive-chat-left { width: 18rem !important; }
            .kanban-column { min-width: 14rem !important; }
            /* Reduce tall fixed panels to fit viewport better */
            .h-80 { height: auto !important; max-height: 50vh !important; }
            .min-h-[400px] { min-height: 320px !important; }
            header h1 { font-size: 1.25rem; }
            main { padding: 1rem; }
            .bottom-nav { display: none !important; }
            .has-bottom-nav { padding-bottom: 1rem !important; }
            .fixed.inset-0 > div, .fixed.inset-0 > .bg-white, .fixed.inset-0 > .bg-white.rounded-xl { max-width: 90% !important; width: 90% !important; height: auto !important; border-radius: 12px !important; }
        }

        @media (max-width: 640px) {
            /* Mobile */
            .responsive-sidebar { display: none !important; }
            .responsive-chat-left { display: none !important; }
            .kanban-column { min-width: 14rem !important; width: 100% !important; }
            main { padding: 0.5rem; }
            header h1 { font-size: 1rem; }
            .chat-view-full { flex-direction: column !important; }
            .kanban-container { flex-direction: column !important; }

            /* Make modals fill screen on mobile for better UX */
            .fixed.inset-0 > div, .fixed.inset-0 > .bg-white, .fixed.inset-0 > .bg-white.rounded-xl {
                max-width: 100% !important;
                width: 100% !important;
                height: 100vh !important;
                border-radius: 0 !important;
                margin: 0 !important;
            }

            /* Bottom navigation bar for quick switching */
            .bottom-nav { display:flex; position:fixed; bottom:0; left:0; right:0; background:white; border-top:1px solid #e2e8f0; padding:6px 8px; justify-content:space-around; z-index:60; }
            /* When `.show-on-mobile` is added to the left chat column, show it full-width and hide the conversation column */
            .show-on-mobile.responsive-chat-left { display: block !important; width: 100% !important; border-right: none !important; }
            .show-on-mobile.responsive-chat-left + .flex-1 { display: none !important; }
            .bottom-nav button{ background:none; border:none; padding:6px 8px; border-radius:8px; color:#374151; display:flex; flex-direction:column; align-items:center; font-size:11px; }
            .bottom-nav button.active { color:#4f46e5; }
            /* Add safe padding so main content is not hidden behind bottom nav */
            .has-bottom-nav { padding-bottom: 4.5rem !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        /**
         * --- SUPABASE CONFIGURATION ---
         * IMPORTANT: Replace these with your Supabase project credentials
         * Get them from: https://app.supabase.com -> Your Project -> Settings -> API
         */
        const SUPABASE_URL = 'https://ptcejmgkctinjzvvpudf.supabase.co'; // e.g., 'https://xxxxx.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0Y2VqbWdrY3Rpbmp6dnZwdWRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MDcwOTIsImV4cCI6MjA3OTI4MzA5Mn0.aNwE0o6u7uHfwlf0uYtGSnYeNPKNWt6MliezIGYjHPQ'; // Your anon/public key
        
        // Use the Supabase client initialized in the pre-script
        // If it wasn't initialized, supabase will be null and app works in offline mode
        const supabase = window.supabaseClient || null;
        
        if (supabase) {
            console.log('‚úÖ Using Supabase client from pre-script');
        } else {
            console.warn('‚ö†Ô∏è Supabase client not available. App will work in offline mode.');
        }

        /**
         * --- ICONS (Lucide Replacements) ---
         */
        const Icon = ({ path, size = 20, className = "", ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
                {...props}
            >
                <g dangerouslySetInnerHTML={{ __html: path }} />
            </svg>
        );

        const Icons = {
            ArrowRightLeft: (props) => <Icon path='<path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/>' {...props} />,
            Layout: (props) => <Icon path='<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="21" y2="9"/>' {...props} />,
            Kanban: (props) => <Icon path='<path d="M6 5v11"/><path d="M12 5v6"/><path d="M18 5v14"/>' {...props} />,
            CheckSquare: (props) => <Icon path='<polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>' {...props} />,
            Users: (props) => <Icon path='<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>' {...props} />,
            BarChart3: (props) => <Icon path='<path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/>' {...props} />,
            Plus: (props) => <Icon path='<path d="M5 12h14"/><path d="M12 5v14"/>' {...props} />,
            Minus: (props) => <Icon path='<path d="M5 12h14"/>' {...props} />,
            MoreVertical: (props) => <Icon path='<circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>' {...props} />,
            Search: (props) => <Icon path='<circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>' {...props} />,
            Bell: (props) => <Icon path='<path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>' {...props} />,
            LogOut: (props) => <Icon path='<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/>' {...props} />,
            ChevronRight: (props) => <Icon path='<path d="m9 18 6-6-6-6"/>' {...props} />,
            ChevronDown: (props) => <Icon path='<path d="m6 9 6 6 6-6"/>' {...props} />,
            ChevronUp: (props) => <Icon path='<path d="m18 15-6-6-6 6"/>' {...props} />,
            Paperclip: (props) => <Icon path='<path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/>' {...props} />,
            MessageSquare: (props) => <Icon path='<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>' {...props} />,
            Calendar: (props) => <Icon path='<rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/>' {...props} />,
            Flag: (props) => <Icon path='<path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/>' {...props} />,
            AlertCircle: (props) => <Icon path='<circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/>' {...props} />,
            CheckCircle2: (props) => <Icon path='<path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/>' {...props} />,
            Clock: (props) => <Icon path='<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>' {...props} />,
            Folder: (props) => <Icon path='<path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/>' {...props} />,
            UserPlus: (props) => <Icon path='<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" x2="20" y1="8" y2="14"/><line x1="23" x2="17" y1="11" y2="11"/>' {...props} />,
            Shield: (props) => <Icon path='<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>' {...props} />,
            Lock: (props) => <Icon path='<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>' {...props} />,
            User: (props) => <Icon path='<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>' {...props} />,
            Edit: (props) => <Icon path='<path d="M17 3a2.85 2.85 0 0 0-4 0L7 13v4h4L21 7.4a2.85 2.85 0 0 0 0-4z"/><line x1="12" x2="15" y1="17" y2="14"/>' {...props} />,
            Trash2: (props) => <Icon path='<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 3a1 1 0 0 0-1-1H10a1 1 0 0 0-1 1v1h6z"/>' {...props} />,
            Hash: (props) => <Icon path='<line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/>' {...props} />,
            Group: (props) => <Icon path='<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>' {...props} />,
            Send: (props) => <Icon path='<line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>' {...props} />,
            X: (props) => <Icon path='<path d="M18 6 6 18"/><path d="m6 6 12 12"/>' {...props} />,
            File: (props) => <Icon path='<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/>' {...props} />,
            Image: (props) => <Icon path='<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>' {...props} />,
            Download: (props) => <Icon path='<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="3" y2="15"/>' {...props} />,
        };

        /**
         * --- DATA & CONSTANTS ---
         */
        
        const INITIAL_PROJECTS = [
            { id: 'p1', name: 'Website Redesign', description: 'Overhaul of the corporate website.', status: 'Active', ownerId: 'u2' },
            { id: 'p2', name: 'Mobile App V2', description: 'Flutter migration and new features.', status: 'Active', ownerId: 'u2' },
            { id: 'p3', name: 'Internal Tooling', description: 'Develop CLI for backend operations.', status: 'Active', ownerId: 'u1' },
        ];

        const getDefaultPermissions = (projects) => {
            return projects.reduce((acc, project) => {
                acc[project.id] = { read: true, write: true };
                return acc;
            }, {});
        };

        const INITIAL_USERS = [
            { id: 'u1', username: 'admin', password: 'admin123', name: 'Alice Admin', role: 'Admin', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Alice', permissions: {} },
            { id: 'u2', username: 'bob', password: '123', name: 'Bob Manager', role: 'Team Member', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Bob', permissions: getDefaultPermissions(INITIAL_PROJECTS) },
            { id: 'u3', username: 'charlie', password: '123', name: 'Charlie Dev', role: 'Team Member', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Charlie', permissions: getDefaultPermissions(INITIAL_PROJECTS) },
            { id: 'u4', username: 'dave', password: '123', name: 'Dave QA', role: 'Team Member', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Dave', permissions: getDefaultPermissions(INITIAL_PROJECTS) },
        ];
        
        const INITIAL_TASKS = [
            { id: 't1', projectId: 'p1', title: 'Setup CI/CD Pipeline', description: 'Configure GitHub Actions for automated deployment.', type: 'Task', priority: 'High', status: 'Completed', assigneeId: 'u3', dueDate: '2023-11-01', 
                subtasks: [{ 
                    id: 'st1', title: 'Write YAML', completed: true, 
                    description: 'Detail: Ensure variable injection is secure and tested.', 
                    priority: 'High', assigneeId: 'u3', dueDate: '2023-10-30', 
                    comments: [{ id: 'sc1', userId: 'u2', text: 'Confirm security review is complete.', timestamp: '2023-10-28 11:00' }],
                    attachments: [{ name: 'ci_config.yaml', size: 1024, type: 'text/yaml' }]
                }], 
                comments: [], createdAt: '2023-10-25',
                attachments: [{ name: 'project_brief.pdf', size: 204800, type: 'application/pdf' }] 
            },
            { id: 't2', projectId: 'p1', title: 'Homepage Hero Animation', description: 'Implement GSAP animation for the landing page.', type: 'User Story', priority: 'Medium', status: 'In Progress', assigneeId: 'u3', dueDate: '2023-11-15', 
                subtasks: [
                    { id: 'st2', title: 'Design Assets', completed: true, description: 'Design assets for the hero section.', priority: 'Medium', assigneeId: 'u2', dueDate: '2023-11-05', comments: [], attachments: [{ name: 'hero_design.fig', size: 5242880, type: 'application/octet-stream' }] }, 
                    { id: 'st3', title: 'Code Animation', completed: false, description: 'Write the GSAP code for smooth transitions.', priority: 'High', assigneeId: 'u3', dueDate: '2023-11-10', comments: [], attachments: [] }
                ], 
                comments: [{ id: 'c1', userId: 'u2', text: 'Make sure it works on mobile.', timestamp: '2023-10-28 10:00' }], createdAt: '2023-10-26',
                attachments: []
            },
            { id: 't3', projectId: 'p3', title: 'Build Database Migrator', description: 'Users getting logged out after 5 minutes unnecessarily.', type: 'Bug', priority: 'High', status: 'To-Do', assigneeId: 'u1', dueDate: '2023-11-10', subtasks: [], comments: [], createdAt: '2023-10-27', attachments: [] },
            { id: 't4', projectId: 'p2', title: 'User Profile API', description: 'Create endpoints for updating user avatar.', type: 'Task', priority: 'Low', status: 'In Review', assigneeId: 'u4', dueDate: '2023-11-20', subtasks: [], comments: [], createdAt: '2023-10-29', attachments: [] }
        ];

        const INITIAL_CHATS = [
            { id: 'c1', type: 'channel', name: 'general', members: ['u1', 'u2', 'u3', 'u4'], isPublic: true },
            { id: 'c2', type: 'channel', name: 'p1-website-redesign', members: ['u1', 'u2', 'u3'], isPublic: false },
            { id: 'c3', type: 'channel', name: 'feedback-and-ideas', members: ['u1', 'u2', 'u3', 'u4'], isPublic: true },
            { id: 'dm-u1-u2', type: 'dm', members: ['u1', 'u2'], isPublic: false }, 
            { id: 'dm-u3-u4', type: 'dm', members: ['u3', 'u4'], isPublic: false }, 
        ];

        const INITIAL_MESSAGES = [
            { id: 'm1', chatId: 'c1', userId: 'u2', text: 'Welcome everyone! Nexus PM is live. Please use this channel for announcements.', timestamp: '2023-12-14 09:00' },
            { id: 'm2', chatId: 'c2', userId: 'u3', text: 'I completed the CI/CD pipeline setup (t1). Ready for review.', timestamp: '2023-12-14 09:05' },
            { id: 'm3', chatId: 'c1', userId: 'u1', text: 'Thanks Bob. Remember, for project-specific discussion use the project channels.', timestamp: '2023-12-14 09:10' },
            { id: 'm4', chatId: 'dm-u1-u2', userId: 'u2', text: 'Can we schedule a 1:1 for the new user permissions?', timestamp: '2023-12-14 09:15' },
            { id: 'm5', chatId: 'dm-u1-u2', userId: 'u1', text: 'Sure, I\'m free at 3 PM today.', timestamp: '2023-12-14 09:16' },
        ];

        const PRIORITY_COLORS = {
            'Low': 'text-slate-500 bg-slate-100',
            'Medium': 'text-amber-600 bg-amber-100',
            'High': 'text-red-600 bg-red-100'
        };

        const STATUS_COLORS = {
            'To-Do': 'bg-slate-400',
            'In Progress': 'bg-blue-400',
            'In Review': 'bg-amber-400',
            'Completed': 'bg-emerald-400'
        };

        const COLORS_CHART = ['#94a3b8', '#3b82f6', '#f59e0b', '#10b981'];

        const formatFileSize = (bytes) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        /**
         * --- UTILITY COMPONENTS ---
         */
        function NavItem({ icon, label, active, onClick }) {
            return (
                <button
                    onClick={onClick}
                    className={`w-full flex items-center space-x-3 px-3 py-2 rounded-lg transition-colors ${
                        active ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                    }`}
                >
                    {icon}
                    <span className="font-medium text-sm">{label}</span>
                </button>
            );
        }

        // --- Chat Module Components ---
        function CreateChatModal({ isOpen, onClose, users, onCreateChat, currentUser }) {
            const [chatType, setChatType] = useState('channel');
            const [chatName, setChatName] = useState('');
            const [isPublic, setIsPublic] = useState(true);
            const [selectedMembers, setSelectedMembers] = useState([currentUser.id]);
            
            if (!isOpen) return null;

            const availableUsers = users.filter(u => u.id !== currentUser.id); 

            const handleMemberToggle = (userId) => {
                setSelectedMembers(prev => {
                    if (chatType === 'dm') {
                        // For DM, radio button behavior: replace selection with new user
                        if (prev.includes(userId)) {
                            // If clicking the already selected user, keep current user only
                            return [currentUser.id];
                        } else {
                            // Replace any other selection with the new user
                            return [currentUser.id, userId];
                        }
                    } else {
                        // For channel, checkbox behavior: toggle selection
                        if (prev.includes(userId)) {
                            return prev.filter(id => id !== userId);
                        } else {
                            return [...prev, userId];
                        }
                    }
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (chatType === 'channel' && !chatName.trim()) {
                    alert('Channel name is required.');
                    return;
                }
                
                const isDm = chatType === 'dm';
                
                // Build the final members array (unique members)
                const finalMembers = isDm
                    ? [...new Set([currentUser.id, ...selectedMembers.filter(id => id !== currentUser.id)])]
                    : [...new Set(selectedMembers)];
                
                if (isDm) {
                    // For DM, we need exactly 2 unique members (currentUser + one other)
                    if (finalMembers.length !== 2) {
                        alert('Direct messages must have exactly two members. Please select one user to message.');
                        return;
                    }
                } else if (finalMembers.length < 2) {
                    alert('Channels must have at least two members (including you).');
                    return;
                }

                const newChat = {
                    id: `${chatType}-${Date.now()}`,
                    type: chatType,
                    name: chatType === 'channel' ? chatName.toLowerCase().replace(/\s/g, '-') : '',
                    members: finalMembers,
                    isPublic: chatType === 'channel' ? isPublic : false,
                };

                onCreateChat(newChat);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                            <h3 className="font-semibold text-slate-900">Create New Chat</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 p-1"><Icons.LogOut size={16} /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            
                            <div className="flex space-x-2 bg-slate-100 p-1 rounded-lg">
                                <button 
                                    type="button"
                                    onClick={() => { setChatType('channel'); setSelectedMembers([currentUser.id]); }}
                                    className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${chatType === 'channel' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}
                                >
                                    <Icons.Hash size={16} className="inline mr-2" /> New Channel/Group
                                </button>
                                <button 
                                    type="button"
                                    onClick={() => { setChatType('dm'); setSelectedMembers([currentUser.id]); }}
                                    className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${chatType === 'dm' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}
                                >
                                    <Icons.User size={16} className="inline mr-2" /> Direct Message
                                </button>
                            </div>

                            {chatType === 'channel' && (
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Channel Name</label>
                                        <input required value={chatName} onChange={e => setChatName(e.target.value)} type="text" className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. general-discussion" />
                                    </div>
                                    <div className="flex items-center space-x-3">
                                        <input type="checkbox" checked={isPublic} onChange={e => setIsPublic(e.target.checked)} id="public-channel" className="form-checkbox h-4 w-4 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500" />
                                        <label htmlFor="public-channel" className="text-sm font-medium text-slate-700">Public Channel (Visible to all users)</label>
                                    </div>
                                </div>
                            )}

                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">
                                    {chatType === 'channel' ? `Members (${selectedMembers.length})` : 'Select User for DM'}
                                </label>
                                <div className="max-h-40 overflow-y-auto border border-slate-200 rounded-lg p-3 space-y-2">
                                    {availableUsers.map(user => (
                                        <div key={user.id} className="flex items-center justify-between">
                                            <div className="flex items-center space-x-2">
                                                <img src={user.avatar} className="w-6 h-6 rounded-full" alt={user.name} />
                                                <span className="text-sm text-slate-700">{user.name}</span>
                                            </div>
                                            <input 
                                                type={chatType === 'dm' ? 'radio' : 'checkbox'} 
                                                name="member-select" 
                                                checked={selectedMembers.includes(user.id)}
                                                onChange={() => handleMemberToggle(user.id)}
                                                disabled={chatType === 'dm' && selectedMembers.includes(user.id) && selectedMembers.length === 2}
                                                className={`form-${chatType === 'dm' ? 'radio' : 'checkbox'} h-4 w-4 text-indigo-600 border-slate-300 focus:ring-indigo-500`} 
                                            />
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="flex justify-end space-x-3 pt-4">
                                <button type="button" onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg">Cancel</button>
                                <button type="submit" className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg">
                                    {chatType === 'channel' ? 'Create Channel' : 'Start DM'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function ChatView({ currentUser, users, chats, messages, activeChatId, setActiveChatId, onSendMessage, onCreateChat, onDeleteChat, onStartCall }) {
            const [isChatModalOpen, setIsChatModalOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [newMessage, setNewMessage] = useState('');
            const [selectedFile, setSelectedFile] = useState(null);
            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);
            const [chatMenuOpenFor, setChatMenuOpenFor] = useState(null);

            const allUsersMap = useMemo(() => 
                users.reduce((acc, u) => { acc[u.id] = u; return acc; }, {}), [users]
            );

            const getChatDisplayName = (chat) => {
                if (chat.type === 'channel') {
                    return chat.name;
                }
                const otherMemberId = chat.members.find(id => id !== currentUser.id);
                return allUsersMap[otherMemberId]?.name || 'Unknown User';
            };

            const userChats = useMemo(() => {
                // Compute last activity timestamp for a chat based on messages
                const getChatLastActivity = (chat) => {
                    const chatMsgs = messages.filter(m => m.chatId === chat.id);
                    if (!chatMsgs || chatMsgs.length === 0) return 0;
                    let maxTs = 0;
                    for (const m of chatMsgs) {
                        let t = 0;
                        // Prefer numeric id timestamp if message ids are like 'm{Date.now()}'
                        if (m.id && typeof m.id === 'string') {
                            const num = parseInt(m.id.replace(/\D/g, ''), 10);
                            if (!isNaN(num)) t = Math.max(t, num);
                        }
                        // Try parsing ISO-ish timestamps like '2023-12-14 09:00' or full ISO
                        if (m.timestamp) {
                            try {
                                const tsCandidate = new Date(String(m.timestamp).replace(' ', 'T')).getTime();
                                if (!isNaN(tsCandidate)) t = Math.max(t, tsCandidate);
                            } catch (e) {
                                // ignored
                            }
                            // Fallback: parse time-only strings like '03:15 PM' as today's time
                            if (t === 0) {
                                const match = String(m.timestamp).match(/(\d{1,2}):(\d{2})(?:\s*)(AM|PM|am|pm)?/);
                                if (match) {
                                    const now = new Date();
                                    let hour = parseInt(match[1], 10);
                                    const minute = parseInt(match[2], 10);
                                    const ampm = match[3];
                                    if (ampm) {
                                        const low = ampm.toLowerCase();
                                        if (low === 'pm' && hour < 12) hour += 12;
                                        if (low === 'am' && hour === 12) hour = 0;
                                    }
                                    const dt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute).getTime();
                                    if (!isNaN(dt)) t = Math.max(t, dt);
                                }
                            }
                        }
                        if (t > maxTs) maxTs = t;
                    }
                    return maxTs;
                };

                return chats
                    .filter(c => c.members.includes(currentUser.id))
                    .sort((a, b) => {
                        const ta = getChatLastActivity(a);
                        const tb = getChatLastActivity(b);
                        if (tb !== ta) return tb - ta; // descending: newest first
                        // fallback: keep channels grouped and then alphabetical
                        const typeCmp = (a.type || '').localeCompare(b.type || '');
                        if (typeCmp !== 0) return typeCmp;
                        return getChatDisplayName(a).localeCompare(getChatDisplayName(b));
                    });
            }, [chats, currentUser.id, allUsersMap, messages]);

            const activeChat = useMemo(() => 
                chats.find(c => c.id === activeChatId), [chats, activeChatId]
            );

            const activeChatMessages = useMemo(() => 
                messages.filter(m => m.chatId === activeChatId), [messages, activeChatId]
            );

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [activeChatMessages]);

            const filteredChats = userChats.filter(chat => 
                getChatDisplayName(chat).toLowerCase().includes(searchTerm.toLowerCase())
            );

            const formatMessageTime = (timestamp) => {
                if (!timestamp) return '';
                // If it's already in locale time format, return as-is
                if (/AM|PM/i.test(timestamp)) return timestamp;
                // Try to parse "YYYY-MM-DD HH:mm" or similar into a time string
                const date = new Date(timestamp.replace(' ', 'T'));
                if (isNaN(date.getTime())) {
                    // Fallback: if parsing fails, show the raw timestamp
                    return timestamp;
                }
                return date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
            };

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setSelectedFile(file);
                }
            };

            const handleSend = (e) => {
                e.preventDefault();
                if ((!newMessage.trim() && !selectedFile) || !activeChatId) return;

                const message = {
                    id: `m${Date.now()}`,
                    chatId: activeChatId,
                    userId: currentUser.id,
                    text: newMessage.trim(),
                    timestamp: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                    attachment: selectedFile ? {
                        name: selectedFile.name,
                        size: selectedFile.size,
                        type: selectedFile.type,
                        url: URL.createObjectURL(selectedFile)
                    } : null
                };

                onSendMessage(message);
                setNewMessage('');
                setSelectedFile(null);
                if(fileInputRef.current) fileInputRef.current.value = '';
            };

            const ChatMessage = ({ message, sender, isCurrentUser }) => {
                const isImage = message.attachment?.type?.startsWith('image/');
                
                return (
                    <div className={`flex mb-4 ${isCurrentUser ? 'justify-end' : 'justify-start'}`}>
                        {!isCurrentUser && (
                            <img 
                                src={sender.avatar} 
                                alt={sender.name} 
                                className="w-8 h-8 rounded-full mr-3 self-end" 
                                title={sender.name}
                            />
                        )}
                        <div className={`max-w-xs lg:max-w-lg p-3 rounded-xl shadow-sm ${
                            isCurrentUser 
                                ? 'bg-indigo-600 text-white rounded-br-none' 
                                : 'bg-white text-slate-800 rounded-tl-none border border-slate-100'
                        }`}>
                            {!isCurrentUser && activeChat.type === 'channel' && (
                                <div className="font-semibold text-xs mb-1" style={{ color: sender.id === 'u1' ? '#ef4444' : '#6366f1' }}>
                                    {sender.name}
                                </div>
                            )}
                            
                            {/* Attachment Rendering */}
                            {message.attachment && (
                                <div className="mb-2 rounded-lg overflow-hidden border border-white/20 bg-black/10">
                                    {isImage ? (
                                        <img src={message.attachment.url} alt="attachment" className="max-w-full h-auto max-h-60 object-contain" />
                                    ) : (
                                        <div className="flex items-center p-3 space-x-3">
                                            <div className="p-2 bg-white/20 rounded-lg">
                                                <Icons.File size={20} className={isCurrentUser ? "text-white" : "text-slate-600"} />
                                            </div>
                                            <div className="overflow-hidden">
                                                <p className="text-sm font-medium truncate">{message.attachment.name}</p>
                                                <p className={`text-xs ${isCurrentUser ? 'text-indigo-200' : 'text-slate-500'}`}>{formatFileSize(message.attachment.size)}</p>
                                            </div>
                                            <a href={message.attachment.url} download={message.attachment.name} className={`p-1.5 rounded-full ${isCurrentUser ? 'hover:bg-indigo-500' : 'hover:bg-slate-100'}`}>
                                                <Icons.Download size={16} />
                                            </a>
                                        </div>
                                    )}
                                </div>
                            )}

                            <p className="text-sm whitespace-pre-wrap">{message.text}</p>
                            <span className={`block text-[10px] mt-1 ${isCurrentUser ? 'text-indigo-200' : 'text-slate-400'} text-right`}>
                                {message.timestamp}
                            </span>
                        </div>
                        {isCurrentUser && (
                            <img 
                                src={sender.avatar} 
                                alt={sender.name} 
                                className="w-8 h-8 rounded-full ml-3 self-end" 
                                title={sender.name}
                            />
                        )}
                    </div>
                );
            };

            return (
                <div className="flex h-full bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden chat-view-full">
                    <div className={`w-80 responsive-chat-left border-r border-slate-100 flex flex-col flex-shrink-0 ${!activeChat ? 'show-on-mobile w-full' : ''}`}>
                        <div className="p-4 flex justify-between items-center border-b border-slate-100">
                            <h2 className="text-lg font-semibold text-slate-800">Messages</h2>
                            <button 
                                onClick={() => setIsChatModalOpen(true)}
                                className="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-full transition-colors shadow-md"
                                title="Create New Channel or DM"
                            >
                                <Icons.Plus size={16} />
                            </button>
                        </div>
                        
                        <div className="p-3">
                            <div className="relative">
                                <Icons.Search size={16} className="absolute left-3 top-2.5 text-slate-400" />
                                <input 
                                    type="text" 
                                    placeholder="Search chats..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full pl-10 pr-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-1 focus:ring-indigo-500 outline-none"
                                />
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto space-y-1 p-3">
                            {filteredChats.map(chat => {
                                const lastMessage = messages.slice().reverse().find(m => m.chatId === chat.id);
                                const isActive = chat.id === activeChatId;

                                const icon = chat.type === 'channel' 
                                    ? <Icons.Hash size={16} className="text-slate-500" />
                                    : <Icons.User size={16} className="text-slate-500" />;
                                
                                return (
                                    <div key={chat.id} className="relative flex items-center group">
                                        <button
                                            onClick={() => setActiveChatId(chat.id)}
                                            className={`flex-1 text-left p-3 rounded-lg flex items-center space-x-3 transition-colors ${
                                                isActive ? 'bg-indigo-100 text-indigo-700' : 'hover:bg-slate-50'
                                            }`}
                                        >
                                            <div className={`p-1 rounded-full ${isActive ? 'bg-indigo-200' : 'bg-slate-100'}`}>
                                                {icon}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <p className="text-sm font-medium truncate">{getChatDisplayName(chat)}</p>
                                                <p className="text-xs text-slate-500 truncate mt-0.5">
                                                    {lastMessage ? (lastMessage.attachment ? 'üìé Attachment' : `${allUsersMap[lastMessage.userId].name}: ${lastMessage.text}`) : 'No messages yet.'}
                                                </p>
                                            </div>
                                            {lastMessage && (
                                                <span className="text-[10px] text-slate-400 flex-shrink-0 ml-2">
                                                    {formatMessageTime(lastMessage.timestamp)}
                                                </span>
                                            )}
                                        </button>
                                        <button
                                            type="button"
                                            className="ml-1 p-1 text-slate-400 hover:text-red-500 rounded-full transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100"
                                            title="More options"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setChatMenuOpenFor(prev => prev === chat.id ? null : chat.id);
                                            }}
                                        >
                                            &#x22EE;
                                        </button>
                                        {chatMenuOpenFor === chat.id && (
                                            <div className="absolute right-0 top-full mt-1 w-32 bg-white border border-slate-200 rounded-lg shadow-lg z-20">
                                                <button
                                                    type="button"
                                                    className="w-full text-left px-3 py-2 text-xs text-red-600 hover:bg-red-50 rounded-lg"
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setChatMenuOpenFor(null);
                                                        if (onDeleteChat) {
                                                            onDeleteChat(chat.id);
                                                        }
                                                    }}
                                                >
                                                    Delete chat
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col">
                        {activeChat ? (
                            <>
                                <div className="p-4 border-b border-slate-100 flex items-center space-x-3 bg-slate-50 flex-shrink-0">
                                    <button
                                        onClick={() => setActiveChatId(null)}
                                        className="md:hidden p-2 rounded-lg mr-1 bg-slate-100 hover:bg-slate-200"
                                        aria-label="Back to chats"
                                        title="Back"
                                    >
                                        <Icons.ChevronRight size={18} className="transform rotate-180" />
                                    </button>
                                    <div className={`p-1 rounded-full ${activeChat.type === 'channel' ? 'bg-indigo-200' : 'bg-slate-200'}`}>
                                        {activeChat.type === 'channel' 
                                            ? <Icons.Hash size={20} className="text-indigo-600" />
                                            : <Icons.User size={20} className="text-slate-600" />
                                        }
                                    </div>
                                    <h3 className="text-lg font-semibold text-slate-800">
                                        {getChatDisplayName(activeChat)}
                                    </h3>
                                <div className="ml-3">
                                    <button
                                        onClick={() => {
                                            if (!activeChat) return;
                                            const other = activeChat.members.find(id => id !== currentUser.id);
                                            if (!other) return alert('Cannot call a channel. Start a DM to call a user.');
                                            if (typeof onStartCall === 'function') onStartCall(other);
                                        }}
                                        className="ml-2 p-2 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-700"
                                        title="Call user"
                                    >
                                        üìû
                                    </button>
                                </div>
                                    <span className="text-sm text-slate-400 ml-2">({activeChat.members.length} members)</span>
                                </div>

                                <div className="flex-1 p-6 overflow-y-auto space-y-4">
                                    {activeChatMessages.map(message => (
                                        <ChatMessage
                                            key={message.id}
                                            message={message}
                                            sender={allUsersMap[message.userId]}
                                            isCurrentUser={message.userId === currentUser.id}
                                        />
                                    ))}
                                    <div ref={messagesEndRef} />
                                </div>

                                <div className="p-4 border-t border-slate-100 bg-white flex-shrink-0">
                                    {selectedFile && (
                                        <div className="mb-2 p-2 bg-slate-50 border border-slate-200 rounded-lg flex items-center justify-between w-fit max-w-full">
                                            <div className="flex items-center space-x-2 text-sm text-slate-600 truncate">
                                                <Icons.File size={16} className="text-indigo-600" />
                                                <span className="truncate max-w-[200px]">{selectedFile.name}</span>
                                                <span className="text-xs text-slate-400">({formatFileSize(selectedFile.size)})</span>
                                            </div>
                                            <button 
                                                onClick={() => { setSelectedFile(null); if(fileInputRef.current) fileInputRef.current.value=''; }}
                                                className="ml-3 text-slate-400 hover:text-red-500 p-1"
                                            >
                                                <Icons.X size={14} />
                                            </button>
                                        </div>
                                    )}
                                    <form onSubmit={handleSend} className="flex space-x-3 items-center">
                                        <input 
                                            type="file" 
                                            ref={fileInputRef}
                                            onChange={handleFileSelect}
                                            className="hidden" 
                                            id="chat-file-upload"
                                        />
                                        <button 
                                            type="button" 
                                            onClick={() => fileInputRef.current?.click()}
                                            className={`p-2 rounded-lg transition-colors ${selectedFile ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400 hover:text-indigo-600 hover:bg-slate-50'}`}
                                            title="Attach File"
                                        >
                                            <Icons.Paperclip size={20} />
                                        </button>
                                        <input
                                            type="text"
                                            value={newMessage}
                                            onChange={(e) => setNewMessage(e.target.value)}
                                            placeholder="Type a message..."
                                            className="flex-1 border border-slate-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                                            disabled={!activeChatId}
                                        />
                                        <button
                                            type="submit"
                                            disabled={(!newMessage.trim() && !selectedFile) || !activeChatId}
                                            className="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 disabled:bg-indigo-300 transition-colors"
                                        >
                                            <Icons.Send size={20} />
                                        </button>
                                    </form>
                                </div>
                            </>
                        ) : (
                            <div className="flex-1 flex items-center justify-center text-slate-500">
                                <div className="text-center">
                                    <Icons.MessageSquare size={48} className="mx-auto text-slate-300 mb-4" />
                                    <p className="font-semibold text-lg text-slate-700">Select a Chat or Create a New One</p>
                                    <p className="text-sm mt-1">Start chatting with your teammates.</p>
                                    <button 
                                        onClick={() => setIsChatModalOpen(true)}
                                        className="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                                    >
                                        <Icons.Plus size={16} className="inline mr-1" /> New Chat
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {isChatModalOpen && (
                        <CreateChatModal
                            isOpen={isChatModalOpen}
                            onClose={() => setIsChatModalOpen(false)}
                            users={users.filter(u => u.id !== 'u1')} 
                            onCreateChat={onCreateChat}
                            currentUser={currentUser}
                        />
                    )}

                </div>
            );
        }

        // --- User Management Components ---

        function UserPermissionRow({ user, onEditProfile, onEditPermissions, onDeleteUser }) {
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const menuRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setIsMenuOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [menuRef]);

            return (
                <tr className="hover:bg-slate-50 relative">
                    <td className="px-4 sm:px-6 py-4 flex items-center space-x-3">
                        <img src={user.avatar} className="w-8 h-8 rounded-full bg-slate-200" alt="" />
                        <span className="font-medium text-slate-900">{user.name}</span>
                    </td>
                    <td className="px-4 sm:px-6 py-4 text-sm text-slate-600">{user.username}</td>
                    <td className="px-4 sm:px-6 py-4">
                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            {user.role}
                        </span>
                    </td>
                    <td className="px-4 sm:px-6 py-4 text-sm text-slate-500 relative">
                        <div ref={menuRef}>
                            <button 
                                onClick={() => setIsMenuOpen(!isMenuOpen)} 
                                className="text-slate-400 hover:text-slate-600 p-1.5 rounded-full hover:bg-slate-100 transition-colors"
                            >
                                <Icons.MoreVertical size={18} />
                            </button>
                            
                            {isMenuOpen && (
                                <div className="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-slate-100 z-50 overflow-hidden">
                                    <div className="py-1">
                                        <button 
                                            onClick={() => { onEditProfile(user); setIsMenuOpen(false); }}
                                            className="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-indigo-600 flex items-center"
                                        >
                                            <Icons.Edit size={14} className="mr-2" /> Edit Credentials
                                        </button>
                                        <button 
                                            onClick={() => { onEditPermissions(user); setIsMenuOpen(false); }}
                                            className="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-indigo-600 flex items-center"
                                        >
                                            <Icons.Lock size={14} className="mr-2" /> Manage Permissions
                                        </button>
                                        <button 
                                            onClick={() => { 
                                                if(window.confirm(`Are you sure you want to delete user "${user.name}"?`)) {
                                                    onDeleteUser(user.id);
                                                }
                                                setIsMenuOpen(false); 
                                            }}
                                            className="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center border-t border-slate-100"
                                        >
                                            <Icons.Trash2 size={14} className="mr-2" /> Delete User
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </td>
                </tr>
            );
        }

        // Avatar picker modal: choose preset avatars or upload an image
        function AvatarModal({ isOpen, onClose, currentUser, onSave }) {
            const [selected, setSelected] = useState(currentUser?.avatar || '');
            const [uploadingName, setUploadingName] = useState('');
            const fileInputRef = useRef(null);

            const presets = [
                'Alice','Bob','Charlie','Dave','Eve','Frank','Grace','Heidi','Ivan','Judy'
            ];

            useEffect(() => {
                setSelected(currentUser?.avatar || '');
            }, [currentUser, isOpen]);

            const handleFile = (file) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    setSelected(e.target.result);
                    setUploadingName(file.name);
                };
                reader.readAsDataURL(file);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 bg-black/40 flex items-center justify-center" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-lg p-6" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="font-semibold">Change Profile Photo</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600">‚úï</button>
                        </div>

                        <div className="mb-4">
                            <div className="flex items-center space-x-4">
                                <img src={selected} alt="preview" className="w-16 h-16 rounded-full border" />
                                <div>
                                    <div className="text-sm font-medium">{currentUser?.name}</div>
                                    <div className="text-xs text-slate-500">{uploadingName || (selected && selected.includes('dicebear') ? 'Preset' : '')}</div>
                                </div>
                            </div>
                        </div>

                        <div className="mb-4">
                            <label className="block text-sm font-medium mb-2">Choose from presets</label>
                            <div className="grid grid-cols-5 gap-3">
                                {presets.map(seed => {
                                    const url = `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(seed)}`;
                                    return (
                                        <button key={seed} type="button" onClick={() => { setSelected(url); setUploadingName(''); }} className={`p-1 rounded-lg border ${selected === url ? 'ring-2 ring-indigo-500' : ''}`}>
                                            <img src={url} alt={seed} className="w-12 h-12 rounded-full" />
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="mb-4">
                            <label className="block text-sm font-medium mb-2">Or upload from device</label>
                            <div className="flex items-center space-x-3">
                                <input ref={fileInputRef} type="file" accept="image/*" className="hidden" onChange={(e) => handleFile(e.target.files[0])} />
                                <button type="button" onClick={() => fileInputRef.current?.click()} className="px-3 py-2 bg-slate-100 rounded-lg text-sm">Upload Image</button>
                                <div className="text-sm text-slate-500">PNG, JPG, GIF accepted</div>
                            </div>
                        </div>

                        <div className="flex justify-end space-x-3">
                            <button onClick={onClose} className="px-4 py-2 rounded-lg text-sm">Cancel</button>
                            <button onClick={() => { onSave(selected); onClose(); }} className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm">Save</button>
                        </div>
                    </div>
                </div>
            );
        }

        // Incoming call modal
        function IncomingCallModal({ callData, onAccept, onDecline }) {
            if (!callData) return null;
            return (
                <div className="fixed inset-0 z-80 flex items-center justify-center bg-black/50 backdrop-blur-sm" onClick={onDecline}>
                    <div className="bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl shadow-2xl w-full max-w-2xl p-6 text-white" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center space-x-6">
                            <img src={allUsers && allUsers.find(u => u.id === callData.from)?.avatar} alt="caller" className="w-24 h-24 rounded-full ring-4 ring-white/20 bg-slate-800" />
                            <div className="flex-1">
                                <div className="text-2xl font-bold">{callData.fromName || 'Unknown'}</div>
                                <div className="text-sm text-white/70 mt-1">is calling you</div>
                                <div className="mt-3 text-xs text-white/60">Incoming audio call ‚Ä¢ Click Accept to join with your microphone enabled</div>
                            </div>
                            <div className="ml-4 text-right">
                                <div className="text-xs text-white/60">From</div>
                                <div className="text-sm font-medium">{callData.from}</div>
                            </div>
                        </div>

                        <div className="mt-6 flex items-center justify-center space-x-6">
                            <button onClick={onDecline} className="flex items-center space-x-2 px-6 py-3 bg-white/10 hover:bg-white/20 text-white rounded-full border border-white/10">
                                <span className="text-lg">Decline</span>
                            </button>
                            <button onClick={onAccept} className="flex items-center space-x-3 px-8 py-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-full text-lg shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 7.2a2 2 0 0 0-1.2-2.1l-3.8-1.6a2 2 0 0 0-2.3.5L9 8"/></svg>
                                <span>Accept</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // In-call UI (visible during call)
        function CallModal({ isCalling, isInCall, targetUser, onHangup, onToggleMute, muted, audioRef, remoteStreamRef, remoteAudioUrl, microphones, speakers, selectedMicId, selectedSpeakerId, onChangeMic, onChangeSpeaker, callStartTime }) {
            const [elapsed, setElapsed] = useState(0);
            useEffect(() => {
                if (!audioRef || !audioRef.current) return;
                try {
                    if (remoteStreamRef && remoteStreamRef.current && 'srcObject' in audioRef.current) {
                        audioRef.current.srcObject = remoteStreamRef.current;
                    } else if (remoteAudioUrl) {
                        audioRef.current.src = remoteAudioUrl;
                    }
                    audioRef.current.autoplay = true;
                    audioRef.current.play().catch(() => {});
                } catch (e) {
                    console.warn('Failed to attach remote audio to element', e);
                }
            }, [remoteAudioUrl, isInCall, isCalling, audioRef, remoteStreamRef]);

            useEffect(() => {
                let timer;
                if (callStartTime) {
                    setElapsed(Math.floor((Date.now() - callStartTime) / 1000));
                    timer = setInterval(() => {
                        setElapsed(Math.floor((Date.now() - callStartTime) / 1000));
                    }, 1000);
                } else {
                    setElapsed(0);
                }
                return () => clearInterval(timer);
            }, [callStartTime]);

            if (!isCalling && !isInCall) return null;

            const formatElapsed = (s) => {
                const hh = String(Math.floor(s / 3600)).padStart(2, '0');
                const mm = String(Math.floor((s % 3600) / 60)).padStart(2, '0');
                const ss = String(s % 60).padStart(2, '0');
                return hh > 0 ? `${hh}:${mm}:${ss}` : `${mm}:${ss}`;
            };

            return (
                <div className="fixed inset-0 z-70 bg-black/60 backdrop-blur-sm flex items-center justify-center p-6">
                    <div className="bg-slate-900 text-white rounded-2xl shadow-2xl w-full max-w-4xl p-6">
                        <div className="grid grid-cols-3 gap-6">
                            <div className="col-span-2 bg-black/20 rounded-xl flex items-center justify-center p-6">
                                <div className="text-center">
                                    <img src={targetUser?.avatar} alt="remote" className="w-48 h-48 rounded-full mx-auto mb-4 ring-4 ring-white/10" />
                                    <div className="text-2xl font-semibold">{targetUser?.name || 'Participant'}</div>
                                    <div className="text-sm text-white/70 mt-1">{isInCall ? `In call ‚Ä¢ ${formatElapsed(elapsed)}` : (isCalling ? 'Calling...' : '')}</div>
                                </div>
                            </div>

                            <div className="col-span-1 flex flex-col justify-between">
                                <div>
                                    <div className="text-sm text-white/70">Audio Devices</div>
                                    <div className="mt-3">
                                        <label className="block text-xs text-white/60">Microphone</label>
                                        <select value={selectedMicId} onChange={e => onChangeMic && onChangeMic(e.target.value)} className="w-full mt-2 p-2 rounded-lg bg-slate-800 border border-white/10">
                                            {microphones && microphones.length ? microphones.map(m => <option key={m.deviceId} value={m.deviceId}>{m.label || 'Microphone'}</option>) : <option>No microphones</option>}
                                        </select>
                                    </div>
                                    <div className="mt-3">
                                        <label className="block text-xs text-white/60">Speaker</label>
                                        <select value={selectedSpeakerId} onChange={e => onChangeSpeaker && onChangeSpeaker(e.target.value)} className="w-full mt-2 p-2 rounded-lg bg-slate-800 border border-white/10">
                                            {speakers && speakers.length ? speakers.map(s => <option key={s.deviceId} value={s.deviceId}>{s.label || 'Speaker'}</option>) : <option>No speakers</option>}
                                        </select>
                                    </div>
                                </div>

                                <div className="mt-4">
                                    <div className="flex flex-col items-center">
                                        <div className="flex items-center space-x-4 mt-2">
                                            <button onClick={() => onToggleMute && onToggleMute()} className="flex items-center flex-col p-3 rounded-full bg-white/6 hover:bg-white/10">
                                                <div className="text-xl">{muted ? 'üîá' : 'üé§'}</div>
                                                <div className="text-xs mt-1">{muted ? 'Unmute' : 'Mute'}</div>
                                            </button>
                                            <button onClick={() => {}} className="flex items-center flex-col p-3 rounded-full bg-white/6 hover:bg-white/10">
                                                <div className="text-xl">‚öôÔ∏è</div>
                                                <div className="text-xs mt-1">Settings</div>
                                            </button>
                                            <button onClick={() => onHangup && onHangup()} className="flex items-center flex-col p-4 rounded-full bg-rose-600 hover:bg-rose-700 text-white shadow-lg">
                                                <div className="text-xl">üìû</div>
                                                <div className="text-xs mt-1">End</div>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="mt-6 text-xs text-white/60">Tip: Use the dropdowns to change microphone or speaker during the call.</div>

                        <div className="mt-4">
                            <audio ref={audioRef} controls className="w-full bg-black rounded-md" />
                        </div>
                    </div>
                </div>
            );
        }

        // Modal to manage project access (admin only)
        function ManageAccessModal({ isOpen, onClose, project, users, onSave }) {
            const [selectedIds, setSelectedIds] = useState(() => {
                if (!project) return [];
                return users.filter(u => u.permissions && u.permissions[project.id] && u.permissions[project.id].read).map(u => u.id);
            });

            useEffect(() => {
                if (!project) return;
                setSelectedIds(users.filter(u => u.permissions && u.permissions[project.id] && u.permissions[project.id].read).map(u => u.id));
            }, [project, users]);

            if (!isOpen || !project) return null;

            const toggle = (userId) => {
                setSelectedIds(prev => prev.includes(userId) ? prev.filter(id => id !== userId) : [...prev, userId]);
            };

            return (
                <div className="fixed inset-0 z-50 bg-black/40 flex items-center justify-center" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="font-semibold">Manage Access - {project.name}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600">‚úï</button>
                        </div>

                        <div className="max-h-60 overflow-y-auto divide-y divide-slate-100">
                            {users.map(u => (
                                <label key={u.id} className="flex items-center py-3">
                                    <div className="flex items-center space-x-3">
                                        <img src={u.avatar} className="w-8 h-8 rounded-full bg-slate-100" alt="" />
                                        <div>
                                            <div className="text-sm font-medium">{u.name}</div>
                                            <div className="text-xs text-slate-500">{u.role}</div>
                                        </div>
                                    </div>
                                    <input className="ml-auto mr-4" type="checkbox" checked={selectedIds.includes(u.id)} onChange={() => toggle(u.id)} />
                                </label>
                            ))}
                        </div>

                        <div className="flex justify-end space-x-3 mt-4">
                            <button onClick={onClose} className="px-4 py-2 rounded-lg">Cancel</button>
                            <button onClick={() => { onSave(project.id, selectedIds); onClose(); }} className="px-4 py-2 bg-indigo-600 text-white rounded-lg">Save</button>
                        </div>
                    </div>
                </div>
            );
        }

        // NEW: Edit User Details Modal
        function EditUserModal({ user, onClose, onSave }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [role, setRole] = useState('Team Member');

            useEffect(() => {
                if(user) {
                    setUsername(user.username);
                    setPassword(user.password);
                    setName(user.name);
                    setRole(user.role);
                }
            }, [user]);

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({ id: user.id, username, password, name, role });
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                            <h3 className="font-semibold text-slate-900">Edit User Credentials</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 p-1"><Icons.LogOut size={16} /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Full Name</label>
                                <input required value={name} onChange={e => setName(e.target.value)} type="text" className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Username</label>
                                <input required value={username} onChange={e => setUsername(e.target.value)} type="text" className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Password</label>
                                <input required value={password} onChange={e => setPassword(e.target.value)} type="text" className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Role</label>
                                <select required value={role} onChange={e => setRole(e.target.value)} className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                                    <option value="Team Member">Team Member</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                            <div className="flex justify-end space-x-3 pt-4">
                                <button type="button" onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg">Cancel</button>
                                <button type="submit" className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // NEW: User Permissions Modal
        function UserPermissionsModal({ user, projects, onClose, onSave }) {
            const [tempPermissions, setTempPermissions] = useState(user.permissions || {});

            const togglePermission = (projectId, type) => {
                setTempPermissions(prev => {
                    const currentPerms = prev[projectId] || { read: false, write: false };
                    let newPerms = { ...currentPerms, [type]: !currentPerms[type] };
                    if (type === 'write' && newPerms.write && !newPerms.read) { newPerms.read = true; }
                    if (type === 'read' && !newPerms.read && newPerms.write) { newPerms.write = false; }
                    return { ...prev, [projectId]: newPerms, };
                });
            };

            const handleSave = () => {
                onSave(user.id, tempPermissions);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-lg overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                            <div>
                                <h3 className="font-semibold text-slate-900">Manage Permissions</h3>
                                <p className="text-xs text-slate-500">For user: {user.name}</p>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 p-1"><Icons.LogOut size={16} /></button>
                        </div>
                        <div className="p-6">
                             <div className="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                                {projects.map(project => {
                                    const perms = tempPermissions[project.id] || { read: false, write: false };
                                    return (
                                        <div key={project.id} className="flex items-center justify-between p-3 bg-white rounded-lg border border-slate-200">
                                            <span className="font-medium text-sm text-slate-700">{project.name}</span>
                                            <div className="flex items-center space-x-6">
                                                <label className="flex items-center space-x-2 text-sm text-slate-600 cursor-pointer">
                                                    <input type="checkbox" checked={!!perms.read} onChange={() => togglePermission(project.id, 'read')} className="form-checkbox h-4 w-4 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500" />
                                                    <span>Read</span>
                                                </label>
                                                <label className="flex items-center space-x-2 text-sm text-slate-600 cursor-pointer">
                                                    <input type="checkbox" checked={!!perms.write} onChange={() => togglePermission(project.id, 'write')} disabled={!perms.read} className="form-checkbox h-4 w-4 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500 disabled:opacity-50" />
                                                    <span>Write</span>
                                                </label>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        <div className="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end space-x-3">
                            <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg">Cancel</button>
                            <button onClick={handleSave} className="px-4 py-2 text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg">Save Permissions</button>
                        </div>
                    </div>
                </div>
            );
        }

        function UserCreationModal({ onClose, onSave }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [role, setRole] = useState('Team Member');

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({ username, password, name, role });
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden">
                        <div className="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                            <h3 className="font-semibold text-slate-900">Create New User</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 p-1"><Icons.LogOut size={16} /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Full Name</label>
                                <input required value={name} onChange={e => setName(e.target.value)} type="text" className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. Jane Doe" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Username</label>
                                <input required value={username} onChange={e => setUsername(e.target.value)} type="text" className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. janed" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Password</label>
                                <input required value={password} onChange={e => setPassword(e.target.value)} type="password" className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="******" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Role</label>
                                <select required value={role} onChange={e => setRole(e.target.value)} className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                                    <option value="Team Member">Team Member</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                            <div className="flex justify-end space-x-3 pt-4">
                                <button type="button" onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg">Cancel</button>
                                <button type="submit" className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg">Create User</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function UserManagementView({ users, projects, onUpdatePermissions, onCreateUser, onEditUser, onDeleteUser }) {
            const [isCreateModalOpen, setIsCreateModal] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [permissionUser, setPermissionUser] = useState(null);

            const managedUsers = users.filter(u => u.role !== 'Admin');

            return (
                <div className="space-y-6">
                    <div className="flex justify-end">
                        <button 
                            onClick={() => setIsCreateModal(true)}
                            className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-colors shadow-md"
                        >
                            <Icons.UserPlus size={16} className="mr-2" /> Add New User
                        </button>
                    </div>
                    
                    <div className="bg-white shadow-sm rounded-xl border border-slate-100 min-h-[400px]">
                        <div className="overflow-x-auto w-full">
                            <table className="w-full table-fixed divide-y divide-slate-200">
                                <thead className="bg-slate-50">
                                    <tr>
                                        <th scope="col" className="px-4 sm:px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">User</th>
                                        <th scope="col" className="px-4 sm:px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Username</th>
                                        <th scope="col" className="px-4 sm:px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Role</th>
                                        <th scope="col" className="px-4 sm:px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-slate-200">
                                    {managedUsers.map((user) => (
                                        <UserPermissionRow 
                                            key={user.id} 
                                            user={user} 
                                            onEditProfile={setEditingUser}
                                            onEditPermissions={setPermissionUser}
                                            onDeleteUser={onDeleteUser}
                                        />
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    {isCreateModalOpen && (
                        <UserCreationModal 
                            onClose={() => setIsCreateModal(false)}
                            onSave={onCreateUser}
                        />
                    )}

                    {editingUser && (
                        <EditUserModal 
                            user={editingUser}
                            onClose={() => setEditingUser(null)}
                            onSave={onEditUser}
                        />
                    )}

                    {permissionUser && (
                        <UserPermissionsModal 
                            user={permissionUser}
                            projects={projects}
                            onClose={() => setPermissionUser(null)}
                            onSave={onUpdatePermissions}
                        />
                    )}
                </div>
            );
        }

        // --- Standard Modules (Dashboard, Projects, Kanban, etc.) ---

        function DashboardView({ tasks, projects }) {
            const stats = [
                { label: 'Total Projects', value: projects.length, icon: Icons.Folder, color: 'bg-blue-500' },
                { label: 'Total Tasks', value: tasks.length, icon: Icons.CheckSquare, color: 'bg-indigo-500' },
                { label: 'Pending Bugs', value: tasks.filter(t => t.type === 'Bug' && t.status !== 'Completed').length, icon: Icons.AlertCircle, color: 'bg-red-500' },
                { label: 'Completed', value: tasks.filter(t => t.status === 'Completed').length, icon: Icons.CheckCircle2, color: 'bg-emerald-500' },
            ];

            const statusData = [
                { name: 'To-Do', value: tasks.filter(t => t.status === 'To-Do').length },
                { name: 'In Progress', value: tasks.filter(t => t.status === 'In Progress').length },
                { name: 'In Review', value: tasks.filter(t => t.status === 'In Review').length },
                { name: 'Completed', value: tasks.filter(t => t.status === 'Completed').length },
            ];

            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                        {stats.map((stat, i) => (
                            <div key={i} className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between">
                                <div>
                                    <p className="text-slate-500 text-sm font-medium">{stat.label}</p>
                                    <p className="text-2xl font-bold text-slate-900 mt-1">{stat.value}</p>
                                </div>
                                <div className={`${stat.color} w-10 h-10 rounded-lg flex items-center justify-center text-white bg-opacity-90`}>
                                    <stat.icon size={20} />
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 h-80 flex flex-col">
                            <h3 className="text-lg font-semibold text-slate-800 mb-2">Task Distribution by Status</h3>
                            <div className="flex-1 w-full">
                                <SimpleBarChart data={statusData} colors={COLORS_CHART} />
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 h-80 flex flex-col">
                            <h3 className="text-lg font-semibold text-slate-800 mb-2">Workload Overview</h3>
                            <div className="flex-1 w-full">
                                <SimplePieChart data={statusData} colors={COLORS_CHART} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function SimpleBarChart({ data, colors }) {
            const maxValue = Math.max(...data.map(d => d.value)) || 1;
            return (
                <div className="flex items-end justify-between h-full w-full pt-4 space-x-2">
                    {data.map((d, i) => {
                        const height = (d.value / maxValue) * 100;
                        return (
                            <div key={i} className="flex flex-col items-center flex-1 h-full justify-end group">
                                <div className="relative w-full flex justify-end flex-col items-center h-[80%]">
                                    <div 
                                        className="w-full max-w-[40px] rounded-t transition-all duration-500 hover:opacity-80 relative"
                                        style={{ height: `${height}%`, backgroundColor: colors[i % colors.length] }}
                                    >
                                        <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                                            {d.name}: {d.value}
                                        </div>
                                    </div>
                                </div>
                                <div className="text-[10px] text-slate-500 mt-2 text-center truncate w-full px-1">{d.name}</div>
                            </div>
                        )
                    })}
                </div>
            )
        };

        function SimplePieChart({ data, colors }) {
            const total = data.reduce((sum, d) => sum + d.value, 0);
            let currentAngle = 0;
            const gradients = data.map((d, i) => {
                const percentage = (d.value / total) * 100;
                const endAngle = currentAngle + percentage;
                const segment = `${colors[i % colors.length]} ${currentAngle}% ${endAngle}%`;
                currentAngle = endAngle;
                return segment;
            });

            return (
                <div className="h-full w-full flex items-center justify-center">
                    <div className="relative w-48 h-48 rounded-full" style={{ background: `conic-gradient(${gradients.join(', ')})` }}>
                        <div className="absolute inset-0 m-auto w-32 h-32 bg-white rounded-full flex items-center justify-center flex-col shadow-inner">
                            <span className="text-2xl font-bold text-slate-800">{total}</span>
                            <span className="text-xs text-slate-500 uppercase font-medium">Tasks</span>
                        </div>
                    </div>
                    <div className="ml-8 space-y-2">
                         {data.map((d, i) => (
                             <div key={i} className="flex items-center text-xs">
                                 <div className="w-3 h-3 rounded-full mr-2" style={{ backgroundColor: colors[i % colors.length] }}></div>
                                 <span className="text-slate-600 font-medium">{d.name} ({d.value})</span>
                             </div>
                         ))}
                    </div>
                </div>
            )
        };

        function ProjectsView({ projects, setCurrentId, setView, users, currentUser, onManageAccess }) {

            if (projects.length === 0) {
                return (
                    <div className="p-8 bg-white rounded-xl shadow-sm border border-slate-100 text-center text-slate-500">
                        <h3 className="text-xl font-semibold text-slate-900 mb-2">No Accessible Projects</h3>
                        <p>There are no projects you currently have read access to.</p>
                    </div>
                );
            }
            
            return (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {projects.map((p) => (
                        <div key={p.id} className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow">
                            <div className="flex justify-between items-start mb-4">
                                <div className="bg-indigo-50 w-10 h-10 rounded-lg flex items-center justify-center text-indigo-600">
                                    <Icons.Folder size={20} />
                                </div>
                                <span className={`px-2 py-1 rounded text-xs font-medium ${p.status === 'Active' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600'}`}>
                                    {p.status}
                                </span>
                            </div>
                            <h3 className="text-lg font-semibold text-slate-900 mb-2">{p.name}</h3>
                            <p className="text-slate-500 text-sm mb-6 line-clamp-2">{p.description}</p>
                            <div className="flex items-center justify-between pt-4 border-t border-slate-50">
                                <div className="flex -space-x-2 items-center">
                                    {users.filter(u => u.permissions && u.permissions[p.id] && u.permissions[p.id].read).slice(0,5).map(u => (
                                        <img key={u.id} src={u.avatar} title={u.name} className="w-7 h-7 rounded-full border-2 border-white" />
                                    ))}
                                    {users.filter(u => u.permissions && u.permissions[p.id] && u.permissions[p.id].read).length > 5 && (
                                        <div className="w-7 h-7 rounded-full bg-slate-200 border-2 border-white flex items-center justify-center text-xs text-slate-600">+{users.filter(u => u.permissions && u.permissions[p.id] && u.permissions[p.id].read).length - 5}</div>
                                    )}
                                </div>
                                <div className="flex items-center space-x-3">
                                    {currentUser && currentUser.role === 'Admin' && (
                                        <button onClick={() => onManageAccess && onManageAccess(p)} title="Manage Access" className="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-100">
                                            +
                                        </button>
                                    )}
                                    <button 
                                        onClick={() => { setCurrentId(p.id); setView('board'); }}
                                        className="text-sm font-medium text-indigo-600 hover:text-indigo-800 flex items-center"
                                    >
                                        View Board <Icons.ChevronRight size={16} className="ml-1" />
                                    </button>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        function KanbanBoard({ tasks, users, onDragStart, onDrop, onEditTask, onDeleteTask, canDrag, canModify, onAddSubtask, onToggleSubtask, onDeleteSubtask, onOpenEditSubtask }) { 
            const columns = ['To-Do', 'In Progress', 'In Review', 'Completed'];

            return (
                <div className="flex h-full overflow-x-auto pb-4 space-x-6 kanban-container">
                    {columns.map(status => {
                        const columnTasks = tasks.filter((t) => t.status === status);
                        return (
                                <div 
                                key={status} 
                                className="flex-shrink-0 w-80 kanban-column flex flex-col h-full bg-slate-100/50 rounded-xl border border-slate-200"
                                onDragOver={(e) => canDrag && e.preventDefault()}
                                onDrop={(e) => canDrag && onDrop(e, status)}
                            >
                                <div className="p-4 border-b border-slate-200 rounded-t-xl flex justify-between items-center bg-white">
                                    <h3 className="font-semibold text-slate-700 flex items-center">
                                        <span className={`w-2 h-2 rounded-full mr-2 ${STATUS_COLORS[status]}`} />
                                        {status}
                                    </h3>
                                    <span className="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded-full font-medium">
                                        {columnTasks.length}
                                    </span>
                                </div>
                                <div className="p-3 flex-1 overflow-y-auto space-y-3 min-h-[100px]">
                                    {columnTasks.map((task) => (
                                        <TaskCard 
                                            key={task.id} 
                                            task={task} 
                                            assignee={users.find((u) => u.id === task.assigneeId)}
                                            onDragStart={canDrag ? onDragStart : () => {}} 
                                            onEdit={onEditTask} 
                                            onDelete={onDeleteTask} 
                                            onAddSubtask={onAddSubtask} 
                                            onToggleSubtask={onToggleSubtask} 
                                            onDeleteSubtask={onDeleteSubtask} 
                                            onOpenEditSubtask={onOpenEditSubtask} 
                                            canDrag={canDrag} 
                                            canModify={canModify} 
                                        />
                                    ))}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        }

        function SubtaskAddForm({ taskId, onAddSubtask }) {
            const [title, setTitle] = useState('');

            const handleAdd = () => {
                const value = title.trim();
                if (!value) return;
                onAddSubtask(taskId, value);
                setTitle('');
            };

            return (
                <div className="flex space-x-2 pt-3 border-t border-dashed border-slate-200">
                    <input 
                        type="text"
                        value={title}
                        onChange={(e) => setTitle(e.target.value)}
                        onKeyDown={(e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                e.stopPropagation();
                                handleAdd();
                            }
                        }}
                        placeholder="Add a subtask..."
                        onClick={(e) => e.stopPropagation()} 
                        onFocus={(e) => e.stopPropagation()} 
                        className="flex-1 border border-slate-300 rounded-lg px-3 py-1 text-sm focus:ring-1 focus:ring-indigo-500 outline-none"
                    />
                    <button 
                        type="button" 
                        disabled={!title.trim()}
                        className="bg-indigo-600 text-white p-1.5 rounded-lg hover:bg-indigo-700 disabled:bg-indigo-300 transition-colors flex items-center justify-center"
                        onClick={(e) => {
                            e.stopPropagation();
                            handleAdd();
                        }} 
                    >
                        <Icons.Plus size={16} />
                    </button>
                </div>
            );
        }

        function TaskCard({ task, assignee, onDragStart, onEdit, onDelete, canDrag, canModify, onAddSubtask, onToggleSubtask, onDeleteSubtask, onOpenEditSubtask }) { 
            const [isExpanded, setIsExpanded] = useState(false);
            
            const completedSubtasks = task.subtasks.filter((st) => st.completed).length;
            
            return (
                <div 
                    draggable={canDrag} 
                    onDragStart={(e) => onDragStart(e, task.id)}
                    className={`bg-white p-4 rounded-lg shadow-sm border border-slate-200 hover:shadow-md transition-shadow group ${canDrag ? 'cursor-grab active:cursor-grabbing' : ''}`}
                >
                    <div className="flex justify-between items-start mb-2">
                        <span className={`text-[10px] px-2 py-0.5 rounded font-medium uppercase tracking-wide ${PRIORITY_COLORS[task.priority]}`}>
                            {task.priority}
                        </span>
                        
                        <div className="flex items-center space-x-1">
                            {task.type === 'Bug' ? <Icons.AlertCircle size={14} className="text-red-500" /> : 
                            task.type === 'User Story' ? <Icons.Flag size={14} className="text-green-600" /> : 
                            <Icons.CheckSquare size={14} className="text-blue-500" />}
                            
                            {canModify && (
                                <>
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); onEdit(task); }} 
                                        className="text-slate-400 hover:text-indigo-600 p-1 rounded transition-colors"
                                        title="Edit Task Details (Modal)"
                                    >
                                        <Icons.Edit size={14} />
                                    </button>
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); onDelete(task.id); }} 
                                        className="text-slate-400 hover:text-red-600 p-1 rounded transition-colors"
                                        title="Delete Task"
                                    >
                                        <Icons.Trash2 size={14} />
                                    </button>
                                </>
                            )}

                            <button 
                                onClick={(e) => { e.stopPropagation(); setIsExpanded(!isExpanded); }}
                                className="text-slate-400 hover:text-indigo-600 p-1 rounded transition-colors"
                                title={isExpanded ? "Collapse Details" : "Expand Details"}
                            >
                                {isExpanded ? <Icons.ChevronUp size={14} /> : <Icons.ChevronDown size={14} />}
                            </button>
                        </div>
                    </div>
                    
                    <h4 className="text-sm font-medium text-slate-800 leading-snug mb-3 group-hover:text-indigo-600 transition-colors">
                        {task.title}
                    </h4>

                    {isExpanded && (
                        <div className="mt-3 border-t pt-3 border-slate-100 space-y-4">
                            <div>
                                <label className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1 block">Description</label>
                                <p className="text-xs text-slate-600 italic leading-relaxed">{task.description}</p>
                            </div>
                            
                            <div className="space-y-2">
                                <label className="text-xs font-semibold text-slate-500 uppercase tracking-wide block">
                                    Subtasks ({completedSubtasks}/{task.subtasks.length})
                                </label>
                                {task.subtasks.length > 0 ? (
                                    <div className="space-y-1">
                                        {task.subtasks.map((st) => (
                                            <div key={st.id} className="flex items-center justify-between group text-sm text-slate-700">
                                                <div className="flex items-center">
                                                    <input 
                                                        type="checkbox"
                                                        checked={st.completed}
                                                        onChange={(e) => { e.stopPropagation(); canModify && onToggleSubtask(task.id, st.id); }}
                                                        onClick={(e) => e.stopPropagation()} 
                                                        disabled={!canModify}
                                                        className="form-checkbox h-4 w-4 text-indigo-600 rounded border-slate-300 mr-2 disabled:opacity-50"
                                                    />
                                                    <span className={st.completed ? 'line-through text-slate-400' : ''}>{st.title}</span>
                                                </div>

                                                {canModify && (
                                                <div className="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button 
                                                            type="button" 
                                                            onClick={(e) => { 
                                                                e.stopPropagation(); 
                                                                onOpenEditSubtask(task, st, 'reassign'); 
                                                            }}
                                                            className="text-slate-400 hover:text-emerald-600 p-1"
                                                            title="Reassign Subtask"
                                                        >
                                                            <Icons.User size={14} />
                                                        </button>
                                                        <button 
                                                            type="button" 
                                                            onClick={(e) => { 
                                                                e.stopPropagation(); 
                                                                onOpenEditSubtask(task, st, 'edit'); 
                                                            }}
                                                            className="text-slate-400 hover:text-indigo-600 p-1"
                                                            title="Edit Subtask Details"
                                                        >
                                                            <Icons.Edit size={14} />
                                                        </button>
                                                        <button 
                                                            type="button" 
                                                            onClick={(e) => { 
                                                                e.stopPropagation(); 
                                                                if(window.confirm(`Delete subtask: "${st.title}"?`)) onDeleteSubtask(task.id, st.id); 
                                                            }}
                                                            className="text-slate-400 hover:text-red-500 p-1"
                                                            title="Delete Subtask"
                                                        >
                                                            <Icons.Trash2 size={14} />
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-xs text-slate-400 italic">No subtasks yet.</p>
                                )}
                            </div>
                        </div>
                    )}

                    <div className={`flex items-center justify-between pt-2 ${isExpanded ? 'border-t border-slate-100 mt-2' : 'border-t border-slate-50'}`}>
                        <div className="flex items-center space-x-3 text-slate-400">
                            {task.subtasks.length > 0 && (
                                <div className="flex items-center text-xs">
                                    <Icons.CheckSquare size={12} className="mr-1" /> 
                                    {completedSubtasks}/{task.subtasks.length}
                                </div>
                            )}
                            {task.comments.length > 0 && (
                                <div className="flex items-center text-xs">
                                    <Icons.MessageSquare size={12} className="mr-1" /> 
                                    {task.comments.length}
                                </div>
                            )}
                        </div>
                        {assignee && (
                            <img 
                                src={assignee.avatar} 
                                alt={assignee.name} 
                                title={`Assigned to ${assignee.name}`}
                                className="w-6 h-6 rounded-full bg-slate-100 border border-white" 
                            />
                        )}
                    </div>
                </div>
            );
        }

        function LoginScreen({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [isUserMode, setIsUserMode] = useState(true); 
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                
                try {
                    const success = await onLogin(username, password, isUserMode ? 'User' : 'Admin');
                    if (!success) {
                        setError('Invalid credentials or permissions. Please check your username, password, and login mode.');
                    }
                } catch (err) {
                    console.error('Login error:', err);
                    setError('Login failed: ' + (err.message || 'Unknown error. Check console for details.'));
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                    <div className="bg-white max-w-md w-full rounded-xl shadow-lg p-8">
                        <div className="text-center mb-8">
                            <div className="bg-indigo-600 w-16 h-16 rounded-xl flex items-center justify-center mx-auto mb-4">
                                <Icons.ArrowRightLeft className="text-white w-8 h-8" />
                            </div>
                            <h1 className="text-2xl font-bold text-slate-900">Nexus PM System</h1>
                            <p className="text-slate-500 mt-2">Log in to your account</p>
                        </div>

                        <div className="bg-slate-100 p-1 rounded-lg flex mb-6">
                            <button 
                                onClick={() => setIsUserMode(false)}
                                className={`flex-1 py-2 text-sm font-medium rounded-md transition-all flex items-center justify-center space-x-2 ${
                                    !isUserMode ? 'bg-white shadow text-indigo-600' : 'text-slate-500 hover:text-slate-700'
                                }`}
                            >
                                <Icons.Shield size={16} />
                                <span>Admin</span>
                            </button>
                            <button 
                                onClick={() => setIsUserMode(true)}
                                className={`flex-1 py-2 text-sm font-medium rounded-md transition-all flex items-center justify-center space-x-2 ${
                                    isUserMode ? 'bg-white shadow text-indigo-600' : 'text-slate-500 hover:text-slate-700'
                                }`}
                            >
                                <Icons.User size={16} />
                                <span>Member</span>
                            </button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Username</label>
                                <div className="relative">
                                    <input 
                                        type="text" 
                                        required 
                                        value={username} 
                                        onChange={(e) => setUsername(e.target.value)}
                                        className="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-colors"
                                        placeholder="Enter your username"
                                    />
                                    <Icons.User size={18} className="absolute left-3 top-2.5 text-slate-400" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Password</label>
                                <div className="relative">
                                    <input 
                                        type="password" 
                                        required 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-colors"
                                        placeholder="Enter your password"
                                    />
                                    <Icons.Lock size={18} className="absolute left-3 top-2.5 text-slate-400" />
                                </div>
                            </div>
                            {error && (
                                <div className="text-sm text-red-600 bg-red-50 p-3 rounded-lg flex items-center space-x-2">
                                    <Icons.AlertCircle size={16} />
                                    <span>{error}</span>
                                </div>
                            )}
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400 text-white font-semibold py-2.5 rounded-lg transition-colors mt-6 flex items-center justify-center"
                            >
                                {loading ? (
                                    <>
                                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                                        Signing In...
                                    </>
                                ) : (
                                    'Sign In'
                                )}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function ProjectModal({ onClose, onSave, ownerId }) {
            const [name, setName] = useState('');
            const [desc, setDesc] = useState('');

            const handleSubmit = (e) => {
                onSave(e, name, desc);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                            <h3 className="font-semibold text-slate-900">Create New Project</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 p-1"><Icons.LogOut size={16} /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Project Name</label>
                                <input required value={name} onChange={e => setName(e.target.value)} type="text" className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. Marketing Campaign" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Description</label>
                                <textarea required value={desc} onChange={e => setDesc(e.target.value)} className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none h-24 resize-none" placeholder="Brief details about the project..." />
                            </div>
                            <div className="flex justify-end space-x-3 pt-4">
                                <button type="button" onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg">Cancel</button>
                                <button type="submit" className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg">Create Project</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function SubtaskModal({ isOpen, onClose, onSave, task, subtask, users, currentUser, canWrite, mode = 'edit' }) {
            const isEditing = !!subtask;
            const isReassignOnly = mode === 'reassign';
            const [title, setTitle] = useState(subtask?.title || '');
            const [desc, setDesc] = useState(subtask?.description || '');
            const [priority, setPriority] = useState(subtask?.priority || 'Medium');
            const [assigneeId, setAssigneeId] = useState(subtask?.assigneeId || users.find(u => u.role !== 'Admin')?.id || '');
            const [dueDate, setDueDate] = useState(subtask?.dueDate || '');
            const [completed, setCompleted] = useState(subtask?.completed || false);
            const [attachments, setAttachments] = useState(subtask?.attachments || []);
            const [comments, setComments] = useState(subtask?.comments || []);
            const [newComment, setNewComment] = useState('');
            const [isAttachmentExpanded, setIsAttachmentExpanded] = useState(false);
            
            const assignableUsers = users.filter(u => u.role !== 'Admin');
            const canEdit = canWrite !== false; // Default to true if not provided

            // Update state when subtask changes
            useEffect(() => {
                if (subtask) {
                    setTitle(subtask.title || '');
                    setDesc(subtask.description || '');
                    setPriority(subtask.priority || 'Medium');
                    setAssigneeId(subtask.assigneeId || users.find(u => u.role !== 'Admin')?.id || '');
                    setDueDate(subtask.dueDate || '');
                    setCompleted(subtask.completed || false);
                    setAttachments(subtask.attachments || []);
                    setComments(subtask.comments || []);
                } else {
                    // Reset for new subtask
                    setTitle('');
                    setDesc('');
                    setPriority('Medium');
                    setAssigneeId(users.find(u => u.role !== 'Admin')?.id || '');
                    setDueDate('');
                    setCompleted(false);
                    setAttachments([]);
                    setComments([]);
                }
                setNewComment('');
                setIsAttachmentExpanded(false);
            }, [subtask, users]);

            const handleAddAttachment = () => {
                if (!canEdit) return alert("Permission denied.");
                document.getElementById('subtask-attachment-upload').click();
            };

            const handleFileSelect = (event) => {
                const files = event.target.files;
                if (files.length > 0) {
                    const newAttachments = Array.from(files).map(file => ({
                        name: file.name,
                        size: file.size,
                        type: file.type || 'application/octet-stream',
                    }));
                    setAttachments(prev => [...prev, ...newAttachments]);
                    setIsAttachmentExpanded(true);
                }
            };

            const handleAddComment = () => {
                if (!newComment.trim()) return;
                const comment = {
                    id: `c${Date.now()}`,
                    userId: currentUser.id,
                    text: newComment.trim(),
                    timestamp: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                };
                setComments(prev => [...prev, comment]);
                setNewComment('');
            };

            if (!isOpen) return null;

            const handleSave = (e) => {
                e.preventDefault();
                const subtaskData = {
                    id: isEditing ? subtask.id : `st${Date.now()}`,
                    title,
                    description: desc,
                    priority,
                    assigneeId,
                    dueDate,
                    completed,
                    comments: comments,
                    attachments: attachments,
                };
                onSave(task.id, subtaskData);
                onClose();
            };
            
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-4xl h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                            <div className="flex items-center space-x-2">
                                <span className="px-2 py-1 rounded text-xs font-bold uppercase bg-indigo-100 text-indigo-700">
                                    {isReassignOnly ? 'Reassign Subtask' : 'Subtask'}
                                </span>
                                <span className="text-slate-400 text-sm">{isEditing ? subtask.id : 'New Subtask'}</span>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 p-1"><Icons.LogOut size={20} /></button>
                        </div>
                        <form onSubmit={handleSave} className="flex-1 overflow-hidden flex flex-col">
                            <input type="file" id="subtask-attachment-upload" multiple onChange={handleFileSelect} className="hidden" />
                            <div className="flex-1 p-6 grid grid-cols-1 md:grid-cols-3 gap-8 overflow-y-auto">
                                {!isReassignOnly && (
                                    <div className="md:col-span-2 space-y-6">
                                        <div>
                                            <label className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2 block">Title</label>
                                            <input required value={title} onChange={e => canEdit && setTitle(e.target.value)} className="w-full text-xl font-bold text-slate-900 placeholder-slate-400 border-none focus:ring-0 p-0 outline-none disabled:bg-transparent" placeholder="Subtask Title" disabled={!canEdit} />
                                        </div>
                                        
                                        <div>
                                            <label className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2 block">Description</label>
                                            <textarea value={desc} onChange={e => setDesc(e.target.value)} className={`w-full border rounded-lg px-3 py-2 text-sm outline-none h-32 resize-none transition-all ${canEdit ? 'border-slate-300 bg-white focus:ring-2 focus:ring-indigo-500' : 'border-transparent bg-slate-50 cursor-default'} ${!canEdit && 'opacity-70'}`} disabled={!canEdit} />
                                        </div>

                                        {isEditing && (
                                            <div>
                                                <div className="flex justify-between items-center mb-2">
                                                    <div className="flex items-center space-x-2">
                                                        <button type="button" onClick={() => setIsAttachmentExpanded(!isAttachmentExpanded)} className="p-1 text-slate-500 hover:text-indigo-600 rounded">{isAttachmentExpanded ? <Icons.Minus size={16} /> : <Icons.Plus size={16} />}</button>
                                                        <label className="text-xs font-semibold text-slate-500 uppercase tracking-wide">Attachments ({attachments.length})</label>
                                                    </div>
                                                    {canEdit && <button type="button" onClick={handleAddAttachment} className="text-xs text-indigo-600 hover:text-indigo-800 flex items-center"><Icons.Paperclip size={14} className="mr-1" /> Upload File</button>}
                                                </div>
                                                {isAttachmentExpanded && (
                                                    <ul className="space-y-1 mt-2">
                                                        {attachments.length > 0 ? attachments.map((att, index) => (
                                                            <li key={att.name + index} className="flex justify-between items-center text-sm text-slate-600 p-2 bg-slate-50 rounded-lg border border-slate-200">
                                                                <span className="truncate font-medium text-indigo-600">{att.name}</span>
                                                                {canEdit && <button type="button" onClick={() => setAttachments(p => p.filter(a => a.name !== att.name))} className="text-red-400 hover:text-red-600 ml-3"><Icons.Trash2 size={14} /></button>}
                                                            </li>
                                                        )) : <p className="text-sm text-slate-400 italic mt-2">No files attached.</p>}
                                                    </ul>
                                                )}
                                            </div>
                                        )}

                                        {isEditing && (
                                            <div className="space-y-4">
                                                <label className="text-xs font-semibold text-slate-500 uppercase tracking-wide block">Comments ({comments.length})</label>
                                                <div className="flex space-x-3">
                                                    <img src={currentUser.avatar} className="w-8 h-8 rounded-full bg-slate-200" alt="" />
                                                    <div className="flex-1 flex items-center space-x-2">
                                                        <input value={newComment} onChange={e => setNewComment(e.target.value)} placeholder="Write a comment..." className="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500" onKeyDown={(e) => { if (e.key === 'Enter' && newComment.trim()) { handleAddComment(); e.preventDefault(); } }} />
                                                        <button type="button" disabled={!newComment.trim()} onClick={handleAddComment} className="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 disabled:opacity-50"><Icons.MessageSquare size={16} /></button>
                                                    </div>
                                                </div>
                                                <div className="space-y-4 max-h-60 overflow-y-auto pr-3">
                                                    {comments.slice().reverse().map(c => (
                                                        <div key={c.id} className="flex space-x-3">
                                                            <img src={users.find(u => u.id === c.userId)?.avatar} className="w-8 h-8 rounded-full bg-slate-200" alt="" />
                                                            <div className="flex-1 p-3 bg-slate-100 rounded-xl">
                                                                <div className="flex justify-between items-center text-xs text-slate-500 mb-1">
                                                                    <span className="font-semibold text-slate-700">{users.find(u => u.id === c.userId)?.name || 'Unknown'}</span>
                                                                    <span>{c.timestamp}</span>
                                                                </div>
                                                                <p className="text-sm text-slate-800">{c.text}</p>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                <div className="space-y-6">
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Status</label>
                                        <div className="flex items-center space-x-2">
                                            <input 
                                                type="checkbox" 
                                                checked={completed} 
                                                onChange={e => canEdit && setCompleted(e.target.checked)} 
                                                disabled={!canEdit}
                                                className="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 disabled:opacity-50"
                                            />
                                            <span className="text-sm text-slate-700">{completed ? 'Completed' : 'In Progress'}</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Assignee</label>
                                        <select value={assigneeId} onChange={e => canEdit && setAssigneeId(e.target.value)} disabled={!canEdit} className="w-full bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-70 disabled:bg-slate-100">
                                            {assignableUsers.map(u => (<option key={u.id} value={u.id}>{u.name}</option>))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Priority</label>
                                        <select value={priority} onChange={e => canEdit && setPriority(e.target.value)} disabled={!canEdit} className="w-full bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-70 disabled:bg-slate-100">
                                            {['Low', 'Medium', 'High'].map(p => (<option key={p} value={p}>{p}</option>))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Due Date</label>
                                        <div className="relative">
                                            <input type="date" value={dueDate} onChange={e => canEdit && setDueDate(e.target.value)} disabled={!canEdit} className="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none disabled:bg-slate-100" />
                                            <Icons.Calendar size={16} className="absolute left-3 top-2.5 text-slate-400" />
                                        </div>
                                    </div>
                                    {isEditing && (
                                        <div>
                                            <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Created Date</label>
                                            <div className="relative">
                                                <input 
                                                    type="text" 
                                                    value={(subtask?.createdAt || task?.createdAt) 
                                                        ? new Date(subtask?.createdAt || task?.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
                                                        : 'N/A'} 
                                                    disabled 
                                                    className="w-full pl-10 pr-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50 text-slate-600 cursor-not-allowed" 
                                                />
                                                <Icons.Calendar size={16} className="absolute left-3 top-2.5 text-slate-400" />
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            <div className="p-4 border-t border-slate-100 bg-white flex justify-end">
                                <button type="submit" disabled={!canEdit && !isEditing} className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg disabled:bg-indigo-300 transition-colors">
                                    {isEditing ? 'Save Changes' : 'Create Subtask'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function TaskModal({ isOpen, onClose, onSave, initialTask, projectId, currentUser, users, onAddComment, canWrite, onOpenEditSubtask, onDeleteSubtask, onToggleSubtask, onAddSubtask }) {
            const isEditing = !!initialTask;
            const [title, setTitle] = useState(initialTask?.title || '');
            const [desc, setDesc] = useState(initialTask?.description || '');
            const [type, setType] = useState(initialTask?.type || 'Task');
            const [priority, setPriority] = useState(initialTask?.priority || 'Medium');
            const [status, setStatus] = useState(initialTask?.status || 'To-Do');
            const [assigneeId, setAssigneeId] = useState(initialTask?.assigneeId || users.find(u => u.role !== 'Admin')?.id || '');
            const [dueDate, setDueDate] = useState(initialTask?.dueDate || '');
            const [newComment, setNewComment] = useState('');
            const [attachments, setAttachments] = useState(initialTask?.attachments || []);
            
            const [isDescEditable, setIsDescEditable] = useState(!isEditing); 
            const [isSubtaskExpanded, setIsSubtaskExpanded] = useState(false);
            const [isAttachmentExpanded, setIsAttachmentExpanded] = useState(false);

            const assignableUsers = users.filter(u => u.role !== 'Admin');

            const handleAddAttachment = () => {
                if (!canWrite) return alert("Permission denied.");
                document.getElementById('task-attachment-upload').click();
            };

            const handleFileSelect = (event) => {
                const files = event.target.files;
                if (files.length > 0) {
                    const newAttachments = Array.from(files).map(file => ({
                        name: file.name,
                        size: file.size,
                        type: file.type || 'application/octet-stream',
                    }));
                    setAttachments(prev => [...prev, ...newAttachments]);
                    setIsAttachmentExpanded(true); 
                }
            };

            const handleSave = (e) => {
                e.preventDefault();
                if (!canWrite && !isEditing) return alert("Permission denied.");

                const taskId = isEditing ? initialTask.id : `t${Date.now()}`;
                const taskData = {
                    id: taskId,
                    projectId,
                    title,
                    description: desc,
                    type,
                    priority,
                    status,
                    assigneeId,
                    dueDate,
                    subtasks: isEditing ? initialTask.subtasks : [],
                    comments: isEditing ? initialTask.comments : [],
                    attachments: attachments, 
                    createdAt: isEditing ? initialTask.createdAt : new Date().toISOString().slice(0, 10)
                };

                onSave(taskData, true);
            };

            const handleAddComment = () => {
                if (!newComment.trim()) return;
                const comment = {
                    id: `c${Date.now()}`,
                    userId: currentUser.id,
                    text: newComment.trim(),
                    timestamp: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                };
                onAddComment(initialTask.id, comment);
                setNewComment('');
            }

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-4xl h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                            <div className="flex items-center space-x-2">
                                <span className={`px-2 py-1 rounded text-xs font-bold uppercase ${type === 'Bug' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`}>{type}</span>
                                <span className="text-slate-400 text-sm">{isEditing ? initialTask.id : 'New Task'}</span>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 p-1"><Icons.LogOut size={20} /></button>
                        </div>
                        <form onSubmit={handleSave} className="flex-1 overflow-hidden flex flex-col">
                            <input type="file" id="task-attachment-upload" multiple onChange={handleFileSelect} className="hidden" />
                            <div className="flex-1 p-6 grid grid-cols-1 md:grid-cols-3 gap-8 overflow-y-auto">
                                <div className="md:col-span-2 space-y-6">
                                    <div>
                                        <label className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2 block">Title</label>
                                        <input required value={title} onChange={e => canWrite && setTitle(e.target.value)} className="w-full text-xl font-bold text-slate-900 placeholder-slate-400 border-none focus:ring-0 p-0 outline-none disabled:bg-transparent" placeholder="Task Title" disabled={!canWrite} />
                                    </div>
                                    
                                    <div>
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="text-xs font-semibold text-slate-500 uppercase tracking-wide block">Description</label>
                                            {isEditing && canWrite && ( 
                                                <button type="button" onClick={() => setIsDescEditable(!isDescEditable)} className="p-1 text-slate-400 hover:text-indigo-600 rounded transition-colors">{isDescEditable ? <Icons.Lock size={16} /> : <Icons.Edit size={16} />}</button>
                                            )}
                                        </div>
                                        <textarea value={desc} onChange={e => setDesc(e.target.value)} className={`w-full border rounded-lg px-3 py-2 text-sm outline-none h-32 resize-none transition-all ${(isDescEditable && canWrite) ? 'border-slate-300 bg-white focus:ring-2 focus:ring-indigo-500' : 'border-transparent bg-slate-50 cursor-default'} ${!canWrite && 'opacity-70'}`} disabled={!isDescEditable || !canWrite} />
                                    </div>

                                    {isEditing && (
                                        <div>
                                            <div className="flex justify-between items-center mb-2">
                                                <div className="flex items-center space-x-2">
                                                    <button type="button" onClick={() => setIsAttachmentExpanded(!isAttachmentExpanded)} className="p-1 text-slate-500 hover:text-indigo-600 rounded">{isAttachmentExpanded ? <Icons.Minus size={16} /> : <Icons.Plus size={16} />}</button>
                                                    <label className="text-xs font-semibold text-slate-500 uppercase tracking-wide">Attachments ({attachments.length})</label>
                                                </div>
                                                {canWrite && <button type="button" onClick={handleAddAttachment} className="text-xs text-indigo-600 hover:text-indigo-800 flex items-center"><Icons.Paperclip size={14} className="mr-1" /> Upload File</button>}
                                            </div>
                                            {isAttachmentExpanded && (
                                                <ul className="space-y-1 mt-2">
                                                    {attachments.length > 0 ? attachments.map((att, index) => (
                                                        <li key={att.name + index} className="flex justify-between items-center text-sm text-slate-600 p-2 bg-slate-50 rounded-lg border border-slate-200">
                                                            <span className="truncate font-medium text-indigo-600">{att.name}</span>
                                                            {canWrite && <button type="button" onClick={() => setAttachments(p => p.filter(a => a.name !== att.name))} className="text-red-400 hover:text-red-600 ml-3"><Icons.Trash2 size={14} /></button>}
                                                        </li>
                                                    )) : <p className="text-sm text-slate-400 italic mt-2">No files attached.</p>}
                                                </ul>
                                            )}
                                        </div>
                                    )}

                                    {isEditing && (
                                        <div>
                                            <div className="flex justify-between items-center mb-2">
                                                <div className="flex items-center space-x-2">
                                                    <button type="button" onClick={() => setIsSubtaskExpanded(!isSubtaskExpanded)} className="p-1 text-slate-500 hover:text-indigo-600 rounded">{isSubtaskExpanded ? <Icons.Minus size={16} /> : <Icons.Plus size={16} />}</button>
                                                    <label className="text-xs font-semibold text-slate-500 uppercase tracking-wide">Subtasks ({initialTask.subtasks?.length || 0})</label>
                                                </div>
                                            </div>
                                            {isSubtaskExpanded && (
                                                <>
                                                    {canWrite && onAddSubtask && (
                                                        <div className="mt-2">
                                                            <SubtaskAddForm taskId={initialTask.id} onAddSubtask={onAddSubtask} />
                                                        </div>
                                                    )}
                                                    <ul className="space-y-2 mt-2">
                                                        {initialTask.subtasks && initialTask.subtasks.length > 0 ? initialTask.subtasks.map((subtask) => (
                                                            <li key={subtask.id} className="flex items-center justify-between text-sm text-slate-600 p-2 bg-slate-50 rounded-lg border border-slate-200">
                                                                <div className="flex items-center space-x-2 flex-1">
                                                                    <input 
                                                                        type="checkbox" 
                                                                        checked={subtask.completed || false} 
                                                                        onChange={(e) => { 
                                                                            e.stopPropagation(); 
                                                                            if (canWrite && onToggleSubtask) {
                                                                                onToggleSubtask(initialTask.id, subtask.id);
                                                                            }
                                                                        }}
                                                                        disabled={!canWrite}
                                                                        className="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 disabled:opacity-50"
                                                                    />
                                                                    <span className={`truncate flex-1 ${subtask.completed ? 'line-through text-slate-400' : 'font-medium text-slate-700'}`}>
                                                                        {subtask.title}
                                                                    </span>
                                                                </div>
                                                                {canWrite && onOpenEditSubtask && (
                                                                    <div className="flex items-center space-x-1 ml-3">
                                                                        <button 
                                                                            type="button" 
                                                                            onClick={() => onOpenEditSubtask(initialTask, subtask, 'reassign')} 
                                                                            className="text-slate-400 hover:text-emerald-600 p-1 rounded hover:bg-emerald-50"
                                                                            title="Reassign Subtask"
                                                                        >
                                                                            <Icons.User size={14} />
                                                                        </button>
                                                                        <button 
                                                                            type="button" 
                                                                            onClick={() => onOpenEditSubtask(initialTask, subtask, 'edit')} 
                                                                            className="text-indigo-600 hover:text-indigo-800 p-1 rounded hover:bg-indigo-50"
                                                                            title="Edit Subtask"
                                                                        >
                                                                            <Icons.Edit size={14} />
                                                                        </button>
                                                                    </div>
                                                                )}
                                                            </li>
                                                        )) : <p className="text-sm text-slate-400 italic mt-2">No subtasks yet.</p>}
                                                    </ul>
                                                </>
                                            )}
                                        </div>
                                    )}

                                    {isEditing && (
                                        <div className="space-y-4">
                                            <label className="text-xs font-semibold text-slate-500 uppercase tracking-wide block">Comments ({initialTask.comments.length})</label>
                                            <div className="flex space-x-3">
                                                <img src={currentUser.avatar} className="w-8 h-8 rounded-full bg-slate-200" alt="" />
                                                <div className="flex-1 flex items-center space-x-2">
                                                    <input value={newComment} onChange={e => setNewComment(e.target.value)} placeholder="Write a comment..." className="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500" onKeyDown={(e) => { if (e.key === 'Enter' && newComment.trim()) { handleAddComment(); e.preventDefault(); } }} />
                                                    <button type="button" disabled={!newComment.trim()} onClick={handleAddComment} className="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 disabled:opacity-50"><Icons.MessageSquare size={16} /></button>
                                                </div>
                                            </div>
                                            <div className="space-y-4 max-h-60 overflow-y-auto pr-3">
                                                {initialTask.comments.slice().reverse().map(c => (
                                                    <div key={c.id} className="flex space-x-3">
                                                        <img src={users.find(u => u.id === c.userId)?.avatar} className="w-8 h-8 rounded-full bg-slate-200" alt="" />
                                                        <div className="flex-1 p-3 bg-slate-100 rounded-xl">
                                                            <div className="flex justify-between items-center text-xs text-slate-500 mb-1">
                                                                <span className="font-semibold text-slate-700">{users.find(u => u.id === c.userId)?.name || 'Unknown'}</span>
                                                                <span>{c.timestamp}</span>
                                                            </div>
                                                            <p className="text-sm text-slate-800">{c.text}</p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="space-y-6">
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Status</label>
                                        <select value={status} onChange={e => canWrite && setStatus(e.target.value)} disabled={!canWrite} className="w-full bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-70 disabled:bg-slate-100">
                                            {['To-Do', 'In Progress', 'In Review', 'Completed'].map(s => (<option key={s} value={s}>{s}</option>))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Assignee</label>
                                        <select value={assigneeId} onChange={e => canWrite && setAssigneeId(e.target.value)} disabled={!canWrite} className="w-full bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-70 disabled:bg-slate-100">
                                            {assignableUsers.map(u => (<option key={u.id} value={u.id}>{u.name}</option>))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Priority</label>
                                        <select value={priority} onChange={e => canWrite && setPriority(e.target.value)} disabled={!canWrite} className="w-full bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-70 disabled:bg-slate-100">
                                            {['Low', 'Medium', 'High'].map(p => (<option key={p} value={p}>{p}</option>))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Due Date</label>
                                        <div className="relative">
                                            <input type="date" value={dueDate} onChange={e => canWrite && setDueDate(e.target.value)} disabled={!canWrite} className="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none disabled:bg-slate-100" />
                                            <Icons.Calendar size={16} className="absolute left-3 top-2.5 text-slate-400" />
                                        </div>
                                    </div>
                                    {isEditing && initialTask.createdAt && (
                                        <div>
                                            <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Created Date</label>
                                            <div className="relative">
                                                <input 
                                                    type="text" 
                                                    value={new Date(initialTask.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })} 
                                                    disabled 
                                                    className="w-full pl-10 pr-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50 text-slate-600 cursor-not-allowed" 
                                                />
                                                <Icons.Calendar size={16} className="absolute left-3 top-2.5 text-slate-400" />
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            <div className="p-4 border-t border-slate-100 bg-white flex justify-end">
                                <button type="submit" disabled={!canWrite && !isEditing} className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg disabled:bg-indigo-300 transition-colors">
                                    {isEditing ? 'Save Changes' : 'Create Task'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        /**
         * --- APP COMPONENT ---
         */
        function App() {
            const [allUsers, setAllUsers] = useState([]);
            const [currentUser, setCurrentUser] = useState(null);
            const [activeView, setActiveView] = useState('dashboard');
            const [projects, setProjects] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [currentProjectId, setCurrentProjectId] = useState(null);
            const [loading, setLoading] = useState(true);
            
            // CHAT STATE
            const [chats, setChats] = useState([]);
            const [messages, setMessages] = useState([]);
            const [activeChatId, setActiveChatId] = useState(null);
            const [isAvatarModalOpen, setIsAvatarModalOpen] = useState(false);
            const [isMobileProfileOpen, setIsMobileProfileOpen] = useState(false);

            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [isProjectModalOpen, setIsProjectModalOpen] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [draggedTaskId, setDraggedTaskId] = useState(null);
            const [editingSubtaskDetails, setEditingSubtaskDetails] = useState(null);
            const [manageAccessProject, setManageAccessProject] = useState(null);
            const [isManageAccessOpen, setIsManageAccessOpen] = useState(false);
            // WebRTC / Calls
                const [callChannel, setCallChannel] = useState(null);
                const [incomingCall, setIncomingCall] = useState(null);
                const [isCalling, setIsCalling] = useState(false);
                const [isInCall, setIsInCall] = useState(false);
                const pcRef = useRef(null);
                const localStreamRef = useRef(null);
                const remoteStreamRef = useRef(null);
                const [remoteAudioUrl, setRemoteAudioUrl] = useState(null);
                const [callTargetId, setCallTargetId] = useState(null);
                const [currentCallId, setCurrentCallId] = useState(null);
                const audioRef = useRef(null);
                const [muted, setMuted] = useState(false);
                const [callStartTime, setCallStartTime] = useState(null);
                const [microphones, setMicrophones] = useState([]);
                const [speakers, setSpeakers] = useState([]);
                const [selectedMicId, setSelectedMicId] = useState('');
                const [selectedSpeakerId, setSelectedSpeakerId] = useState('');

            // Restore session from localStorage on mount (before loading data)
            useEffect(() => {
                try {
                    const storedUser = localStorage.getItem('nexus_current_user');
                    const storedView = localStorage.getItem('nexus_active_view');
                    const storedProjectId = localStorage.getItem('nexus_current_project_id');
                    const storedChatId = localStorage.getItem('nexus_active_chat_id');

                    if (storedUser) {
                        const parsedUser = JSON.parse(storedUser);
                        setCurrentUser(parsedUser);
                    }
                    if (storedView) {
                        setActiveView(storedView);
                    }
                    if (storedProjectId) {
                        setCurrentProjectId(storedProjectId);
                    }
                    if (storedChatId) {
                        setActiveChatId(storedChatId);
                    }
                } catch (e) {
                    console.warn('Failed to restore session from localStorage', e);
                }
            }, []);

            // Persist key pieces of state to localStorage
            useEffect(() => {
                if (currentUser) {
                    localStorage.setItem('nexus_current_user', JSON.stringify(currentUser));
                } else {
                    localStorage.removeItem('nexus_current_user');
                }
            }, [currentUser]);

            useEffect(() => {
                if (activeView) {
                    localStorage.setItem('nexus_active_view', activeView);
                }
            }, [activeView]);

            useEffect(() => {
                if (currentProjectId) {
                    localStorage.setItem('nexus_current_project_id', currentProjectId);
                }
            }, [currentProjectId]);

            useEffect(() => {
                if (activeChatId) {
                    localStorage.setItem('nexus_active_chat_id', activeChatId);
                } else {
                    localStorage.removeItem('nexus_active_chat_id');
                }
            }, [activeChatId]);

            // Load data from Supabase on mount
            useEffect(() => {
                if (!supabase) {
                    setLoading(false);
                    return;
                }

                const loadData = async () => {
                    try {
                        // Load users
                        const { data: usersData, error: usersError } = await supabase
                            .from('users')
                            .select('*');
                        if (usersError) {
                            console.error('Error loading users:', usersError);
                            if (usersError.code === '42P01') {
                                console.error('Users table does not exist. Please run SUPABASE_SCHEMA.sql in your Supabase SQL Editor.');
                            }
                        } else if (usersData) {
                            if (usersData.length === 0) {
                                console.warn('No users found in database. You may need to insert sample users. Check SUPABASE_SCHEMA.sql for sample data.');
                            }
                            setAllUsers(usersData.map(u => ({
                                ...u,
                                permissions: typeof u.permissions === 'string' ? JSON.parse(u.permissions) : (u.permissions || {})
                            })));
                        }

                        // Load projects
                        const { data: projectsData, error: projectsError } = await supabase
                            .from('projects')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (!projectsError && projectsData) {
                            // Normalize field names (owner_id -> ownerId for compatibility)
                            const normalizedProjects = projectsData.map(p => ({
                                ...p,
                                ownerId: p.owner_id || p.ownerId
                            }));
                            setProjects(normalizedProjects);
                            if (normalizedProjects.length > 0 && !currentProjectId) {
                                setCurrentProjectId(normalizedProjects[0].id);
                            }
                        }

                        // Load tasks
                        const { data: tasksData, error: tasksError } = await supabase
                            .from('tasks')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (!tasksError && tasksData) {
                            // Normalize field names for compatibility
                            setTasks(tasksData.map(t => ({
                                ...t,
                                projectId: t.project_id || t.projectId,
                                assigneeId: t.assignee_id || t.assigneeId,
                                dueDate: t.due_date || t.dueDate,
                                createdAt: t.created_at || t.createdAt,
                                subtasks: typeof t.subtasks === 'string' ? JSON.parse(t.subtasks) : (t.subtasks || []),
                                comments: typeof t.comments === 'string' ? JSON.parse(t.comments) : (t.comments || []),
                                attachments: typeof t.attachments === 'string' ? JSON.parse(t.attachments) : (t.attachments || [])
                            })));
                        }

                        // Load chats
                        const { data: chatsData, error: chatsError } = await supabase
                            .from('chats')
                            .select('*');
                        if (!chatsError && chatsData) {
                            setChats(chatsData.map(c => ({
                                ...c,
                                isPublic: c.is_public !== undefined ? c.is_public : c.isPublic,
                                members: typeof c.members === 'string' ? JSON.parse(c.members) : (c.members || [])
                            })));
                        }

                        // Load messages
                        const { data: messagesData, error: messagesError } = await supabase
                            .from('messages')
                            .select('*')
                            .order('timestamp', { ascending: true });
                        if (!messagesError && messagesData) {
                            setMessages(messagesData.map(m => ({
                                ...m,
                                chatId: m.chat_id || m.chatId,
                                userId: m.user_id || m.userId,
                                attachment: m.attachment ? (typeof m.attachment === 'string' ? JSON.parse(m.attachment) : m.attachment) : null
                            })));
                        }
                    } catch (error) {
                        console.error('Error loading data:', error);
                    } finally {
                        setLoading(false);
                    }
                };

                loadData();

                // Set up real-time subscriptions
                if (supabase) {
                    // Subscribe to tasks changes
                    const tasksChannel = supabase
                        .channel('tasks-changes')
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, (payload) => {
                            const task = payload.new || payload.old;
                            if (payload.eventType === 'DELETE') {
                                setTasks(prev => prev.filter(t => t.id !== task.id));
                            } else {
                                const formattedTask = {
                                    ...task,
                                    projectId: task.project_id || task.projectId,
                                    assigneeId: task.assignee_id || task.assigneeId,
                                    dueDate: task.due_date || task.dueDate,
                                    createdAt: task.created_at || task.createdAt,
                                    subtasks: typeof task.subtasks === 'string' ? JSON.parse(task.subtasks) : (task.subtasks || []),
                                    comments: typeof task.comments === 'string' ? JSON.parse(task.comments) : (task.comments || []),
                                    attachments: typeof task.attachments === 'string' ? JSON.parse(task.attachments) : (task.attachments || [])
                                };
                                if (payload.eventType === 'INSERT') {
                                    setTasks(prev => [...prev, formattedTask]);
                                } else {
                                    setTasks(prev => prev.map(t => t.id === formattedTask.id ? formattedTask : t));
                                }
                            }
                        })
                        .subscribe();

                    // Subscribe to messages changes
                    const messagesChannel = supabase
                        .channel('messages-changes')
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, (payload) => {
                            const message = payload.new || payload.old;
                            if (payload.eventType === 'DELETE') {
                                setMessages(prev => prev.filter(m => m.id !== message.id));
                            } else {
                                const formattedMessage = {
                                    ...message,
                                    chatId: message.chat_id || message.chatId,
                                    userId: message.user_id || message.userId,
                                    attachment: message.attachment ? (typeof message.attachment === 'string' ? JSON.parse(message.attachment) : message.attachment) : null
                                };
                                if (payload.eventType === 'INSERT') {
                                    // Add message to local state
                                    setMessages(prev => [...prev, formattedMessage]);

                                    // If the chat for this message is not yet known locally, add a placeholder immediately
                                    setChats(prevChats => {
                                        const exists = prevChats.some(c => c.id === formattedMessage.chatId);
                                        if (exists) return prevChats;
                                        const placeholder = {
                                            id: formattedMessage.chatId,
                                            type: 'dm',
                                            name: '',
                                            members: [formattedMessage.userId],
                                            isPublic: false
                                        }; 
                                        return [...prevChats, placeholder];
                                    });

                                    // Try to fetch the real chat row from the server and replace/merge when available
                                    if (supabase) {
                                        (async () => {
                                            try {
                                                const { data: chatRow, error: chatError } = await supabase
                                                    .from('chats')
                                                    .select('*')
                                                    .eq('id', formattedMessage.chatId)
                                                    .maybeSingle();

                                                if (!chatError && chatRow) {
                                                    const normalized = {
                                                        ...chatRow,
                                                        isPublic: chatRow.is_public !== undefined ? chatRow.is_public : chatRow.isPublic,
                                                        members: typeof chatRow.members === 'string' ? JSON.parse(chatRow.members) : (chatRow.members || [])
                                                    };
                                                    setChats(prev => {
                                                        if (prev.some(c => c.id === normalized.id)) {
                                                            return prev.map(c => c.id === normalized.id ? normalized : c);
                                                        }
                                                        return [...prev, normalized];
                                                    });
                                                }
                                            } catch (e) {
                                                console.error('Error fetching chat for incoming message:', e);
                                            }
                                        })();
                                    }
                                } else {
                                    setMessages(prev => prev.map(m => m.id === formattedMessage.id ? formattedMessage : m));
                                }
                            }
                        })
                        .subscribe();

                    return () => {
                        supabase.removeChannel(tasksChannel);
                        supabase.removeChannel(messagesChannel);
                        if (callChannel) supabase.removeChannel(callChannel);
                    };
                }
            }, []); 

            // Setup a broadcast channel for WebRTC signaling
            useEffect(() => {
                if (!supabase || !currentUser) return;

                const channel = supabase.channel('webrtc-signaling');
                channel.on('broadcast', { event: '*' }, (payload) => {
                    const msg = (payload && (payload.payload || payload)) || payload;
                    try {
                        const data = msg.payload || msg;
                        if (!data || data.target !== currentUser.id) return;

                        // handle signaling messages
                        if (data.type === 'call-init') {
                            // incoming call
                            setIncomingCall({ from: data.from, fromName: data.fromName, offer: data.offer, callId: data.callId });
                        } else if (data.type === 'offer') {
                            // Offer received (for direct offer flow)
                            setIncomingCall({ from: data.from, fromName: data.fromName, offer: data.offer, callId: data.callId });
                        } else if (data.type === 'answer') {
                            if (pcRef.current) {
                                pcRef.current.setRemoteDescription(new RTCSessionDescription(data.answer)).catch(console.error);
                            }
                        } else if (data.type === 'ice') {
                            if (pcRef.current && data.candidate) {
                                pcRef.current.addIceCandidate(new RTCIceCandidate(data.candidate)).catch(console.error);
                            }
                        } else if (data.type === 'hangup') {
                            // remote hung up
                            endCallLocal();
                        }
                    } catch (e) {
                        console.error('Error handling signaling payload', e, payload);
                    }
                }).subscribe();

                setCallChannel(channel);

                return () => {
                    try { if (channel) supabase.removeChannel(channel); } catch(e){}
                };
            }, [supabase, currentUser]);

            // Helper to broadcast signaling messages
            const sendSignal = async (data) => {
                try {
                    if (callChannel && typeof callChannel.send === 'function') {
                        await callChannel.send({ type: 'broadcast', event: 'webrtc', payload: data });
                        return;
                    }
                    if (supabase && typeof supabase.channel === 'function') {
                        // Fallback: create a temporary channel to broadcast
                        try {
                            await supabase.channel('webrtc-signaling').send({ type: 'broadcast', event: 'webrtc', payload: data });
                            return;
                        } catch (e) {
                            console.warn('Fallback broadcast failed', e);
                        }
                    }
                } catch (e) {
                    console.error('Failed to send signal', e);
                }
            };

            const createPeerConnection = (targetId) => {
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });

                pc.onicecandidate = (e) => {
                    if (e.candidate) {
                        sendSignal({ type: 'ice', candidate: e.candidate, from: currentUser.id, target: targetId });
                    }
                };

                pc.ontrack = (e) => {
                    remoteStreamRef.current = e.streams[0];
                    try {
                        // If our audio element is available, attach the stream directly for reliable playback
                        if (audioRef && audioRef.current && 'srcObject' in audioRef.current) {
                            try {
                                audioRef.current.srcObject = e.streams[0];
                                audioRef.current.muted = false;
                                audioRef.current.play().catch(() => {});
                            } catch (innerErr) {
                                console.warn('Failed to attach stream via srcObject, falling back to object URL', innerErr);
                                const url = URL.createObjectURL(e.streams[0]);
                                setRemoteAudioUrl(url);
                            }
                        } else {
                            const url = URL.createObjectURL(e.streams[0]);
                            setRemoteAudioUrl(url);
                        }
                    } catch (err) {
                        console.warn('Could not attach remote stream to audio', err);
                    }
                };

                return pc;
            };

            const startCall = async (targetId) => {
                if (!supabase) return alert('Realtime (Supabase) is required for calls.');
                setIsCalling(true);
                pcRef.current = createPeerConnection(targetId);

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                    localStreamRef.current = stream;
                    stream.getTracks().forEach(track => pcRef.current.addTrack(track, stream));

                    const offer = await pcRef.current.createOffer();
                    await pcRef.current.setLocalDescription(offer);

                    const callId = `call-${Date.now()}`;
                    setCallTargetId(targetId);
                    setCurrentCallId(callId);
                    setCallStartTime(Date.now());
                    await sendSignal({ type: 'offer', offer: offer, from: currentUser.id, fromName: currentUser.name, target: targetId, callId });
                    setIsInCall(true);
                } catch (e) {
                    console.error('Start call error', e);
                    alert('Failed to start call: ' + e.message);
                    setIsCalling(false);
                }
            };

            const acceptIncomingCall = async () => {
                if (!incomingCall) return;
                const { from, offer, callId } = incomingCall;
                pcRef.current = createPeerConnection(from);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                    localStreamRef.current = stream;
                    stream.getTracks().forEach(track => pcRef.current.addTrack(track, stream));

                    await pcRef.current.setRemoteDescription(new RTCSessionDescription(offer));
                    const answer = await pcRef.current.createAnswer();
                    await pcRef.current.setLocalDescription(answer);

                    setCallTargetId(from);
                    setCurrentCallId(callId);
                    await sendSignal({ type: 'answer', answer: answer, from: currentUser.id, fromName: currentUser.name, target: from, callId });
                    setIsInCall(true);
                    setIncomingCall(null);
                    setCallStartTime(Date.now());
                } catch (e) {
                    console.error('Accept call error', e);
                    alert('Failed to accept call: ' + e.message);
                    setIncomingCall(null);
                }
            };

            const declineIncomingCall = async () => {
                if (incomingCall) {
                    await sendSignal({ type: 'hangup', from: currentUser.id, target: incomingCall.from, callId: incomingCall.callId });
                }
                setIncomingCall(null);
            };

            const endCallLocal = () => {
                try {
                    // notify remote party
                    if (callTargetId) {
                        try { sendSignal({ type: 'hangup', from: currentUser.id, target: callTargetId, callId: currentCallId }); } catch(e){}
                    }
                    if (pcRef.current) {
                        pcRef.current.close();
                        pcRef.current = null;
                    }
                    if (localStreamRef.current) {
                        localStreamRef.current.getTracks().forEach(t => t.stop());
                        localStreamRef.current = null;
                    }
                    if (remoteStreamRef.current) {
                        remoteStreamRef.current.getTracks().forEach(t => t.stop());
                        remoteStreamRef.current = null;
                    }
                    if (remoteAudioUrl) { try { URL.revokeObjectURL(remoteAudioUrl); } catch(e){} }
                } catch (e) {
                    console.warn('Error ending call', e);
                }
                setRemoteAudioUrl(null);
                setCallTargetId(null);
                setCurrentCallId(null);
                setMuted(false);
                setCallStartTime(null);
                setIsInCall(false);
                setIsCalling(false);
                setIncomingCall(null);
            };

            const loadDevices = async () => {
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) return;
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const mics = devices.filter(d => d.kind === 'audioinput');
                    const spk = devices.filter(d => d.kind === 'audiooutput');
                    setMicrophones(mics);
                    setSpeakers(spk);
                    if (!selectedMicId && mics[0]) setSelectedMicId(mics[0].deviceId);
                    if (!selectedSpeakerId && spk[0]) setSelectedSpeakerId(spk[0].deviceId);
                } catch (e) {
                    console.warn('Failed to load media devices', e);
                }
            };

            const changeMicrophone = async (deviceId) => {
                try {
                    const constraints = { audio: { deviceId: deviceId ? { exact: deviceId } : undefined }, video: false };
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    // replace tracks in peer connection
                    if (pcRef.current) {
                        const senders = pcRef.current.getSenders();
                        const audioTrack = stream.getAudioTracks()[0];
                        const sender = senders.find(s => s.track && s.track.kind === 'audio');
                        if (sender) {
                            sender.replaceTrack(audioTrack);
                        } else {
                            pcRef.current.addTrack(audioTrack, stream);
                        }
                    }
                    // stop previous local tracks
                    if (localStreamRef.current) {
                        localStreamRef.current.getTracks().forEach(t => t.stop());
                    }
                    localStreamRef.current = stream;
                    setSelectedMicId(deviceId);
                    setMuted(false);
                } catch (e) {
                    console.warn('Failed to switch microphone', e);
                    alert('Could not switch microphone: ' + e.message);
                }
            };

            const changeSpeaker = async (deviceId) => {
                try {
                    if (audioRef && audioRef.current && typeof audioRef.current.setSinkId === 'function') {
                        await audioRef.current.setSinkId(deviceId);
                        setSelectedSpeakerId(deviceId);
                    } else {
                        console.warn('setSinkId not supported in this browser');
                        alert('Changing speaker output is not supported by this browser.');
                    }
                } catch (e) {
                    console.warn('Failed to change speaker', e);
                }
            };

            useEffect(() => {
                // try to populate devices on mount
                loadDevices();
            }, []);

            useEffect(() => {
                // refresh devices when call activity starts
                if (isCalling || isInCall) loadDevices();
            }, [isCalling, isInCall]);

            const toggleMute = () => {
                try {
                    if (!localStreamRef.current) return;
                    const newMuted = !muted;
                    localStreamRef.current.getAudioTracks().forEach(t => t.enabled = !newMuted);
                    setMuted(newMuted);
                } catch (e) {
                    console.warn('Failed to toggle mute', e);
                }
            };

            const canAccessProject = (user, projectId, level = 'read') => {
                if (!user) return false;
                if (user.role === 'Admin') return true;
                const projectPerms = user.permissions[projectId];
                if (!projectPerms) return false;
                if (level === 'read') return projectPerms.read;
                if (level === 'write') return projectPerms.write;
                return false;
            };

            const visibleProjects = useMemo(() => {
                if (!currentUser) return [];
                return projects.filter(p => canAccessProject(currentUser, p.id, 'read'));
            }, [currentUser, projects]);

            const currentProject = useMemo(() => {
                return projects.find(p => p.id === currentProjectId);
            }, [currentProjectId, projects]);

            const currentProjectTasks = useMemo(() => {
                return tasks.filter(t => t.projectId === currentProjectId);
            }, [currentProjectId, tasks]);
            
            const currentProjectCanWrite = useMemo(() => {
                return currentUser && currentProjectId ? canAccessProject(currentUser, currentProjectId, 'write') : false;
            }, [currentUser, currentProjectId]);

            const canModifyTask = currentProjectCanWrite;
            const canUpdateStatus = currentProjectCanWrite;
            
            useEffect(() => {
                if (currentUser && currentProjectId && !canAccessProject(currentUser, currentProjectId, 'read')) {
                    const firstAccessible = visibleProjects[0];
                    if (firstAccessible) {
                        setCurrentProjectId(firstAccessible.id);
                    } else if (projects.length > 0) {
                        setCurrentProjectId(''); 
                        if (activeView === 'board') {
                            setActiveView('projects'); 
                        }
                    }
                }
                
                if (currentUser && !activeChatId) {
                    const defaultChat = chats.find(c => c.members.includes(currentUser.id) && c.type === 'channel');
                    if(defaultChat) setActiveChatId(defaultChat.id);
                }

            }, [currentUser, currentProjectId, visibleProjects, projects, activeView, activeChatId, chats]);

            const handleSaveTask = async (task, closeModal = true) => {
                if (!supabase) {
                    // Fallback to local state
                    setTasks(prevTasks => {
                        const existingTaskIndex = prevTasks.findIndex(t => t.id === task.id);
                        if (existingTaskIndex > -1) {
                            const updatedTasks = prevTasks.map((t, index) => index === existingTaskIndex ? task : t);
                            if (editingTask && editingTask.id === task.id) setEditingTask(task);
                            return updatedTasks;
                        } else {
                            return [...prevTasks, task];
                        }
                    });
                    if (closeModal) { setIsTaskModalOpen(false); setEditingTask(null); }
                    return;
                }

                try {
                    // Convert to database format (camelCase -> snake_case)
                    const taskData = {
                        project_id: task.projectId,
                        title: task.title,
                        description: task.description,
                        type: task.type,
                        priority: task.priority,
                        status: task.status,
                        assignee_id: task.assigneeId,
                        due_date: task.dueDate,
                        subtasks: JSON.stringify(task.subtasks || []),
                        comments: JSON.stringify(task.comments || []),
                        attachments: JSON.stringify(task.attachments || [])
                    };

                    const existingTask = tasks.find(t => t.id === task.id);
                    if (existingTask) {
                        // Update existing task
                        const { error } = await supabase
                            .from('tasks')
                            .update(taskData)
                            .eq('id', task.id);
                        
                        if (error) throw error;
                    } else {
                        // Insert new task
                        const { error } = await supabase
                            .from('tasks')
                            .insert([{ ...taskData, id: task.id }]);
                        
                        if (error) throw error;
                    }

                    // Update local state
                    setTasks(prevTasks => {
                        const existingTaskIndex = prevTasks.findIndex(t => t.id === task.id);
                        if (existingTaskIndex > -1) {
                            const updatedTasks = prevTasks.map((t, index) => index === existingTaskIndex ? task : t);
                            if (editingTask && editingTask.id === task.id) setEditingTask(task);
                            return updatedTasks;
                        } else {
                            return [...prevTasks, task];
                        }
                    });

                    if (closeModal) { setIsTaskModalOpen(false); setEditingTask(null); }
                } catch (error) {
                    console.error('Error saving task:', error);
                    alert('Failed to save task. Please try again.');
                }
            };
            
            const handleOpenEditSubtask = (task, subtask, mode = 'edit') => {
                if (!canModifyTask) return alert("Permission denied.");
                setEditingSubtaskDetails({ taskId: task.id, subtask, mode });
            };

            const handleSaveSubtask = async (taskId, subtaskData) => {
                if (!canModifyTask) return;
                
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;

                const existingSubtaskIndex = task.subtasks.findIndex(st => st.id === subtaskData.id);
                let newSubtasks;
                if (existingSubtaskIndex > -1) {
                    newSubtasks = task.subtasks.map(st => st.id === subtaskData.id ? subtaskData : st);
                } else {
                    newSubtasks = [...task.subtasks, subtaskData];
                }

                const updatedTask = { ...task, subtasks: newSubtasks };
                
                // Save to Supabase
                if (supabase) {
                    try {
                        const taskData = {
                            project_id: updatedTask.projectId,
                            title: updatedTask.title,
                            description: updatedTask.description,
                            type: updatedTask.type,
                            priority: updatedTask.priority,
                            status: updatedTask.status,
                            assignee_id: updatedTask.assigneeId,
                            due_date: updatedTask.dueDate,
                            subtasks: JSON.stringify(updatedTask.subtasks),
                            comments: JSON.stringify(updatedTask.comments || []),
                            attachments: JSON.stringify(updatedTask.attachments || [])
                        };
                        const { error } = await supabase
                            .from('tasks')
                            .update(taskData)
                            .eq('id', taskId);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.error('Error saving subtask:', error);
                        alert('Failed to save subtask. Please try again.');
                        return;
                    }
                }

                setTasks(prevTasks => prevTasks.map(t => t.id === taskId ? updatedTask : t));
            };

            const handleAddSubtaskFromCard = (taskId, title) => {
                if (!canModifyTask) return alert("Permission denied.");
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;
                const newSubtaskId = `st${Date.now()}`;
                const newSubtask = { id: newSubtaskId, title: title, completed: false, description: '', priority: 'Medium', assigneeId: task.assigneeId, dueDate: '', comments: [], attachments: [], };
                handleSaveTask({ ...task, subtasks: [...task.subtasks, newSubtask] }, false); 
            };

            const deleteSubtask = (taskId, subtaskId) => {
                if (!canModifyTask) return alert("Permission denied.");
                if (!window.confirm("Are you sure?")) return;
                const task = tasks.find(t => t.id === taskId);
                handleSaveTask({ ...task, subtasks: task.subtasks.filter(st => st.id !== subtaskId) }, false); 
            }

            const toggleSubtask = (taskId, subtaskId) => {
                if (!canModifyTask) return alert("Permission denied.");
                const task = tasks.find(t => t.id === taskId);
                handleSaveTask({ ...task, subtasks: task.subtasks.map(st => st.id === subtaskId ? { ...st, completed: !st.completed } : st) }, false);
            }
            
            const handleOpenEditTask = (task) => {
                setEditingTask(task);
                setIsTaskModalOpen(true);
            }

            const handleDeleteTask = async (taskId) => {
                if (!canModifyTask) return alert("Permission denied.");
                if (!window.confirm("Are you sure?")) return;

                if (supabase) {
                    try {
                        const { error } = await supabase
                            .from('tasks')
                            .delete()
                            .eq('id', taskId);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.error('Error deleting task:', error);
                        alert('Failed to delete task. Please try again.');
                        return;
                    }
                }

                setTasks(tasks.filter(t => t.id !== taskId));
            };

            const openManageAccess = (project) => {
                setManageAccessProject(project);
                setIsManageAccessOpen(true);
            };

            const handleSaveProjectAccess = async (projectId, selectedUserIds) => {
                // Update local users' permissions
                setAllUsers(prev => prev.map(u => {
                    const has = selectedUserIds.includes(u.id);
                    const newPerms = { ...(u.permissions || {}) };
                    if (has) {
                        // Grant read-only access via Manage Access modal
                        newPerms[projectId] = { read: true, write: false };
                    } else {
                        delete newPerms[projectId];
                    }
                    return { ...u, permissions: newPerms };
                }));

                // Persist to Supabase if available
                if (supabase) {
                    try {
                        // Update each affected user row
                        for (const uId of allUsers.map(u=>u.id)) {
                            const user = allUsers.find(x => x.id === uId) || { permissions: {} };
                            const updatedPerms = user.permissions || {};
                            // ensure the latest from local setAllUsers: read from DOM state
                            const localUser = (await (async () => {
                                return allUsers.find(x => x.id === uId);
                            })());
                            const permsToSave = localUser ? localUser.permissions : updatedPerms;
                            const { error } = await supabase
                                .from('users')
                                .update({ permissions: JSON.stringify(permsToSave) })
                                .eq('id', uId);
                            if (error) console.error('Failed to persist permissions for', uId, error);
                        }
                    } catch (e) {
                        console.error('Error saving permissions to server:', e);
                    }
                }
            };
            
            const handleDragStart = (e, taskId) => {
                if (!canUpdateStatus) return;
                setDraggedTaskId(taskId);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDrop = (e, status) => {
                e.preventDefault();
                if (!canUpdateStatus || !draggedTaskId) return;
                const taskToUpdate = tasks.find(t => t.id === draggedTaskId);
                if (taskToUpdate) handleSaveTask({ ...taskToUpdate, status }, true); 
                setDraggedTaskId(null);
            };

            const addComment = (taskId, comment) => {
                const task = tasks.find(t => t.id === taskId);
                if (task) handleSaveTask({ ...task, comments: [...task.comments, comment] }, false);
            }
            
            const handleLogin = async (username, password, mode) => {
                console.log('üîê Login attempt:', { username, mode, passwordLength: password.length });
                
                if (!supabase) {
                    console.warn('‚ö†Ô∏è Supabase not initialized, using local fallback');
                    // Fallback to local authentication if Supabase not configured
                    const user = allUsers.find(u => u.username === username && u.password === password);
                    if (user) {
                        if (mode === 'Admin' && user.role !== 'Admin') {
                            console.error('‚ùå Login failed: User is not an Admin');
                            return false;
                        }
                        console.log('‚úÖ Login successful (local fallback)');
                        setCurrentUser(user);
                        setActiveView('dashboard');
                        return true;
                    }
                    console.error('‚ùå Login failed: User not found in local data');
                    return false;
                }

                try {
                    // Query user by username only (more reliable, avoids RLS issues with password field)
                    console.log('üîç Querying Supabase for user:', username);
                    const { data: userData, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('username', username)
                        .maybeSingle(); // Use maybeSingle() to get single result or null
                    
                    if (error) {
                        console.error('‚ùå Error querying users table:', error);
                        console.error('Error code:', error.code);
                        console.error('Error message:', error.message);
                        console.error('Error details:', JSON.stringify(error, null, 2));
                        
                        // Check for RLS policy errors
                        if (error.message && (error.message.includes('permission') || error.message.includes('RLS'))) {
                            console.error('üîí RLS Policy Error: Row Level Security is blocking the query');
                            console.error('üí° Solution: Run this in Supabase SQL Editor:');
                            console.error('   ALTER TABLE users DISABLE ROW LEVEL SECURITY;');
                            console.error('   Or create a policy: CREATE POLICY "Allow public read" ON users FOR SELECT USING (true);');
                        }
                        return false;
                    }

                    if (!userData) {
                        console.error('‚ùå No user found with username:', username);
                        console.log('üí° Tip: Make sure the user exists in your Supabase users table');
                        return false;
                    }

                    console.log('‚úÖ Found user with username:', { id: userData.id, username: userData.username, role: userData.role });

                    // Compare password in JavaScript (more reliable than querying with password)
                    // Trim both to handle any whitespace issues
                    const storedPassword = (userData.password || '').trim();
                    const providedPassword = (password || '').trim();
                    
                    if (storedPassword !== providedPassword) {
                        console.error('‚ùå Login failed: Password incorrect for username:', username);
                        console.log('üí° Password does not match. Verify password in Supabase Table Editor');
                        return false;
                    }

                    // Get the matched user
                    const matchedUser = userData;
                    console.log('‚úÖ Password verified for user:', { id: matchedUser.id, username: matchedUser.username, role: matchedUser.role });

                    // Check role match - mode can be 'Admin' or 'User' (Member)
                    // If mode is 'Admin', user must be 'Admin'. 
                    // If mode is 'User' (Member toggle), user can be 'Admin' or 'Team Member'
                    if (mode === 'Admin' && matchedUser.role !== 'Admin') {
                        console.error('‚ùå Login failed: User is not an Admin but Admin mode was selected');
                        console.log('User role:', matchedUser.role, 'Required:', 'Admin');
                        console.log('üí° Switch to Member mode or use an Admin account');
                        return false;
                    }
                    
                    // For 'User' mode (Member toggle), allow both 'Admin' and 'Team Member' roles
                    if (mode === 'User') {
                        if (matchedUser.role !== 'Admin' && matchedUser.role !== 'Team Member') {
                            console.error('‚ùå Login failed: User role is invalid');
                            console.log('User role:', matchedUser.role, 'Expected: Admin or Team Member');
                            return false;
                        }
                        console.log('‚úÖ Role check passed for Member mode:', matchedUser.role);
                    }

                    // Format user data
                    let parsedPermissions = {};
                    try {
                        if (typeof matchedUser.permissions === 'string') {
                            parsedPermissions = JSON.parse(matchedUser.permissions);
                        } else if (matchedUser.permissions) {
                            parsedPermissions = matchedUser.permissions;
                        }
                    } catch (parseError) {
                        console.warn('‚ö†Ô∏è Failed to parse permissions, using empty object:', parseError);
                        parsedPermissions = {};
                    }
                    
                    const user = {
                        ...matchedUser,
                        permissions: parsedPermissions
                    };

                    console.log('‚úÖ Login successful! Setting current user...');
                    setCurrentUser(user);
                    setActiveView('dashboard');
                    return true;
                } catch (error) {
                    console.error('‚ùå Unexpected login error:', error);
                    console.error('Error stack:', error.stack);
                    throw error; // Re-throw to be caught by LoginScreen
                }
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setActiveView('dashboard');
                setCurrentProjectId('p1');
                setActiveChatId(null); 
                try {
                    localStorage.removeItem('nexus_current_user');
                    localStorage.removeItem('nexus_active_view');
                    localStorage.removeItem('nexus_current_project_id');
                    localStorage.removeItem('nexus_active_chat_id');
                } catch (e) {
                    console.warn('Failed to clear session from localStorage', e);
                }
            };

            const handleUpdatePermissions = async (userId, newPermissions) => {
                if (supabase) {
                    try {
                        const { error } = await supabase
                            .from('users')
                            .update({ permissions: JSON.stringify(newPermissions) })
                            .eq('id', userId);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.error('Error updating permissions:', error);
                        alert('Failed to update permissions. Please try again.');
                        return;
                    }
                }
                setAllUsers(prevUsers => prevUsers.map(u => u.id === userId ? { ...u, permissions: newPermissions } : u ));
            };

            const handleEditUser = async (updatedUser) => {
                if (supabase) {
                    try {
                        const userData = {
                            ...updatedUser,
                            permissions: typeof updatedUser.permissions === 'object' ? JSON.stringify(updatedUser.permissions) : updatedUser.permissions
                        };
                        const { error } = await supabase
                            .from('users')
                            .update(userData)
                            .eq('id', updatedUser.id);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.error('Error updating user:', error);
                        alert('Failed to update user. Please try again.');
                        return;
                    }
                }
                setAllUsers(prevUsers => prevUsers.map(u => u.id === updatedUser.id ? { ...u, ...updatedUser } : u));
            };

            const handleDeleteUser = async (userId) => {
                if (!window.confirm("Are you sure you want to delete this user? This action cannot be undone.")) return;

                if (supabase) {
                    try {
                        const { error } = await supabase
                            .from('users')
                            .delete()
                            .eq('id', userId);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.error('Error deleting user:', error);
                        alert('Failed to delete user. Please try again.');
                        return;
                    }
                }
                setAllUsers(prev => prev.filter(u => u.id !== userId));
            };

            const handleCreateUser = async (newUser) => {
                const newUserId = `u${Date.now()}`;
                const initialPermissions = projects.reduce((acc, project) => {
                    acc[project.id] = { read: true, write: true };
                    return acc;
                }, {});
                const user = { 
                    id: newUserId, 
                    ...newUser, 
                    avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${newUser.name.replace(/\s/g, '')}`, 
                    permissions: initialPermissions, 
                };

                if (supabase) {
                    try {
                        const userData = {
                            ...user,
                            permissions: JSON.stringify(user.permissions)
                        };
                        const { error } = await supabase
                            .from('users')
                            .insert([userData]);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.error('Error creating user:', error);
                        alert('Failed to create user. Please try again.');
                        return;
                    }
                }
                setAllUsers([...allUsers, user]);
            };

            const handleCreateProject = async (e, name, desc) => {
                e.preventDefault();
                // UPDATED: Only Admins can create projects now
                if (!currentUser || currentUser.role !== 'Admin') return alert("Permission denied. Only Admins can create projects.");
                
                const newProjectId = `p${Date.now()}`;
                const newProject = { id: newProjectId, name, description: desc, status: 'Active', ownerId: currentUser.id };

                if (supabase) {
                    try {
                        // Convert to database format (ownerId -> owner_id)
                        const projectData = {
                            ...newProject,
                            owner_id: newProject.ownerId
                        };
                        delete projectData.ownerId;
                        
                        const { error } = await supabase
                            .from('projects')
                            .insert([projectData]);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.error('Error creating project:', error);
                        alert('Failed to create project. Please try again.');
                        return;
                    }
                }

                setProjects([...projects, newProject]);

                // Update user permissions for new project
                if (supabase) {
                    // Update all non-admin users' permissions
                    for (const user of allUsers) {
                        if (user.role !== 'Admin') {
                            const updatedPermissions = { ...user.permissions, [newProjectId]: { read: true, write: true } };
                            await supabase
                                .from('users')
                                .update({ permissions: JSON.stringify(updatedPermissions) })
                                .eq('id', user.id);
                            
                            setAllUsers(prevUsers => prevUsers.map(u => 
                                u.id === user.id ? { ...u, permissions: updatedPermissions } : u
                            ));
                        }
                    }
                } else {
                    setAllUsers(prevUsers => prevUsers.map(u => {
                        if (u.role !== 'Admin') {
                            return { ...u, permissions: { ...u.permissions, [newProjectId]: { read: true, write: true } } };
                        }
                        return u;
                    }));
                }
            };

            // CHAT
            const handleCreateChat = async (newChat) => {
                // If this is a DM, check if a chat with the same participants already exists.
                if (newChat.type === 'dm') {
                    const newMembersSet = new Set(newChat.members || []);
                    const existingDm = chats.find(c => {
                        if ((c.type || '').toLowerCase() !== 'dm') return false;
                        const members = Array.isArray(c.members) ? c.members : [];
                        // Normalize existing members as a set to ignore duplicates
                        const existingSet = new Set(members);
                        if (existingSet.size !== newMembersSet.size) return false;
                        for (const id of newMembersSet) {
                            if (!existingSet.has(id)) return false;
                        }
                        return true;
                    });

                    if (existingDm) {
                        // Open the existing DM instead of creating a new one
                        setActiveChatId(existingDm.id);
                        return;
                    }
                }

                if (supabase) {
                    try {
                        const chatData = {
                            id: newChat.id,
                            type: newChat.type,
                            name: newChat.name,
                            is_public: newChat.isPublic,
                            members: JSON.stringify(newChat.members || [])
                        };
                        const { error } = await supabase
                            .from('chats')
                            .insert([chatData]);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.error('Error creating chat:', error);
                        alert('Failed to create chat. Please try again.');
                        return;
                    }
                }
                setChats(prev => [...prev, newChat]);
                setActiveChatId(newChat.id);
            };

            const handleSendMessage = async (message) => {
                if (supabase) {
                    try {
                        const messageData = {
                            id: message.id,
                            chat_id: message.chatId,
                            user_id: message.userId,
                            text: message.text,
                            timestamp: message.timestamp,
                            attachment: message.attachment ? JSON.stringify(message.attachment) : null
                        };
                        const { error } = await supabase
                            .from('messages')
                            .insert([messageData]);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.error('Error sending message:', error);
                        alert('Failed to send message. Please try again.');
                        return;
                    }
                }
            };

            const handleDeleteChat = async (chatId) => {
                // Optimistically update local state
                setChats(prev => prev.filter(c => c.id !== chatId));
                setMessages(prev => prev.filter(m => m.chatId !== chatId));
                if (activeChatId === chatId) {
                    setActiveChatId(null);
                }

                if (supabase) {
                    try {
                        // Delete messages for this chat first due to FK constraints
                        const { error: msgError } = await supabase
                            .from('messages')
                            .delete()
                            .eq('chat_id', chatId);
                        if (msgError) throw msgError;

                        const { error: chatError } = await supabase
                            .from('chats')
                            .delete()
                            .eq('id', chatId);
                        if (chatError) throw chatError;
                    } catch (error) {
                        console.error('Error deleting chat:', error);
                        alert('Failed to delete chat from the server. It will be removed locally only.');
                    }
                }
            };

            const handleSaveAvatar = async (avatarUrl) => {
                if (!currentUser) return;
                // Optimistic update local state
                const updatedUser = { ...currentUser, avatar: avatarUrl };
                setCurrentUser(updatedUser);
                setAllUsers(prev => prev.map(u => u.id === updatedUser.id ? { ...u, avatar: avatarUrl } : u));

                // Persist to Supabase if available
                if (supabase) {
                    try {
                        const { error } = await supabase
                            .from('users')
                            .update({ avatar: avatarUrl })
                            .eq('id', updatedUser.id);
                        if (error) throw error;
                    } catch (e) {
                        console.error('Failed to save avatar to server:', e);
                    }
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-slate-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                            <p className="text-slate-600">Loading...</p>
                        </div>
                    </div>
                );
            }

            if (!currentUser) return <LoginScreen onLogin={handleLogin} />;

            return (
                <div className="flex h-screen overflow-hidden">
                    <div className="w-64 responsive-sidebar bg-slate-900 flex flex-col flex-shrink-0">
                        <div className="p-4 border-b border-slate-800 flex items-center">
                            <Icons.ArrowRightLeft size={24} className="text-indigo-500 mr-3 transform rotate-90" />
                            <span className="font-extrabold text-white text-lg">Nexus</span>
                        </div>
                        <nav className="flex-1 px-4 space-y-2 mt-4 overflow-y-auto">
                            <NavItem icon={<Icons.BarChart3 size={20} />} label="Dashboard" active={activeView === 'dashboard'} onClick={() => setActiveView('dashboard')} />
                            <NavItem icon={<Icons.Folder size={20} />} label="Projects" active={activeView === 'projects'} onClick={() => setActiveView('projects')} />
                            <NavItem icon={<Icons.MessageSquare size={20} />} label="Chat" active={activeView === 'chat'} onClick={() => setActiveView('chat')} />
                            {currentUser.role === 'Admin' && (
                                <NavItem icon={<Icons.UserPlus size={20} />} label="User Management" active={activeView === 'users'} onClick={() => setActiveView('users')} />
                            )}
                        </nav>
                        <div className="p-4 border-t border-slate-800 flex items-center justify-between">
                            <div className="flex items-center space-x-3">
                                <button onClick={() => setIsAvatarModalOpen(true)} title="Change avatar" className="relative p-0 rounded-full overflow-hidden">
                                    <img src={currentUser.avatar} className="w-8 h-8 rounded-full bg-slate-700 hover:opacity-90" alt="" />
                                    <span className="absolute -bottom-1 -right-1 bg-white rounded-full p-[2px] border border-slate-200 text-xs">‚úé</span>
                                </button>
                                <div className="text-sm">
                                    <span className="block text-white font-medium">{currentUser.name}</span>
                                    <span className="block text-slate-400 text-xs">{currentUser.role}</span>
                                </div>
                            </div>
                            <button onClick={handleLogout} className="text-slate-400 hover:text-white p-2 rounded-lg">
                                <Icons.LogOut size={18} />
                            </button>
                        </div>
                    </div>

                    <main className="flex-1 p-6 overflow-y-auto flex flex-col space-y-6 has-bottom-nav">
                        <header className="flex justify-between items-center flex-shrink-0">
                            <h1 className="text-2xl font-bold text-slate-900">
                                {activeView === 'dashboard' && 'Dashboard Overview'}
                                {activeView === 'projects' && 'All Projects'}
                                {activeView === 'users' && 'User Management'}
                                {activeView === 'chat' && 'Internal Team Chat'}
                                {activeView === 'board' && currentProject && `Kanban Board: ${currentProject.name}`}
                                {activeView === 'board' && !currentProject && 'Kanban Board'}
                            </h1>
                            {(activeView === 'board' && currentProjectCanWrite) && (
                                <button 
                                    onClick={() => { setIsTaskModalOpen(true); setEditingTask(null); }}
                                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-colors shadow-md"
                                >
                                    <Icons.Plus size={16} className="mr-2" /> New Task
                                </button>
                            )}
                            {(activeView === 'projects' && currentUser.role === 'Admin') && (
                                <button onClick={() => setIsProjectModalOpen(true)} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-colors shadow-md" >
                                    <Icons.Plus size={16} className="mr-2" /> New Project
                                </button>
                            )}
                        </header>

                        {activeView === 'dashboard' && <DashboardView tasks={tasks} projects={projects} />}
                        
                        {activeView === 'projects' && (
                            <ProjectsView projects={visibleProjects} setCurrentId={setCurrentProjectId} setView={setActiveView} users={allUsers} currentUser={currentUser} onManageAccess={openManageAccess} />
                        )}
                        
                        {activeView === 'chat' && (
                            <ChatView 
                                currentUser={currentUser} 
                                users={allUsers} 
                                chats={chats}
                                messages={messages}
                                activeChatId={activeChatId}
                                setActiveChatId={setActiveChatId}
                                onSendMessage={handleSendMessage}
                                onCreateChat={handleCreateChat}
                                onDeleteChat={handleDeleteChat}
                                onStartCall={startCall}
                            />
                        )}
                        
                        {activeView === 'users' && currentUser.role === 'Admin' && (
                            <UserManagementView 
                                users={allUsers} 
                                projects={projects}
                                onUpdatePermissions={handleUpdatePermissions} 
                                onCreateUser={handleCreateUser}
                                onEditUser={handleEditUser}
                                onDeleteUser={handleDeleteUser}
                            />
                        )}
                        
                        {activeView === 'board' && currentProject && (
                            <KanbanBoard 
                                tasks={currentProjectTasks} 
                                users={allUsers} 
                                onDragStart={handleDragStart} 
                                onDrop={handleDrop} 
                                onEditTask={handleOpenEditTask}
                                onDeleteTask={handleDeleteTask}
                                onAddSubtask={handleAddSubtaskFromCard} 
                                onToggleSubtask={toggleSubtask} 
                                onDeleteSubtask={deleteSubtask} 
                                onOpenEditSubtask={handleOpenEditSubtask} 
                                canDrag={canUpdateStatus} 
                                canModify={canModifyTask} 
                            />
                        )}
                        {activeView === 'board' && !currentProject && (
                            <div className="p-8 bg-white rounded-xl shadow-sm border border-slate-100 text-center text-slate-500">
                                Please select an accessible project from the **Projects** list to view the Kanban board.
                            </div>
                        )}

                    </main>

                    {/* Mobile bottom navigation */}
                    <div className="bottom-nav md:hidden lg:hidden" role="navigation" aria-label="Mobile navigation">
                        <button onClick={() => setActiveView('dashboard')} className={activeView === 'dashboard' ? 'active' : ''} title="Dashboard">
                            <Icons.BarChart3 size={20} />
                            <span>Home</span>
                        </button>
                        <button onClick={() => setActiveView('projects')} className={activeView === 'projects' ? 'active' : ''} title="Projects">
                            <Icons.Folder size={20} />
                            <span>Projects</span>
                        </button>
                        <button onClick={() => setActiveView('chat')} className={activeView === 'chat' ? 'active' : ''} title="Chat">
                            <Icons.MessageSquare size={20} />
                            <span>Chat</span>
                        </button>
                        {currentUser && currentUser.role === 'Admin' && (
                            <button onClick={() => setActiveView('users')} className={activeView === 'users' ? 'active' : ''} title="Users">
                                <Icons.UserPlus size={20} />
                                <span>Users</span>
                            </button>
                        )}
                        <button onClick={() => setIsMobileProfileOpen(true)} title="Profile">
                            <img src={currentUser?.avatar} className="w-5 h-5 rounded-full" alt="profile" />
                            <span>Me</span>
                        </button>
                    </div>

                    {isTaskModalOpen && currentProject && (
                        <TaskModal 
                            isOpen={isTaskModalOpen} 
                            onClose={() => setIsTaskModalOpen(false)}
                            onSave={handleSaveTask}
                            initialTask={editingTask}
                            projectId={currentProjectId}
                            currentUser={currentUser}
                            users={allUsers}
                            onAddComment={addComment}
                            canWrite={currentProjectCanWrite}
                            onOpenEditSubtask={handleOpenEditSubtask} 
                            onDeleteSubtask={deleteSubtask}
                            onToggleSubtask={toggleSubtask}
                            onAddSubtask={handleAddSubtaskFromCard}
                        />
                    )}

                    {/* Mobile Profile Sheet */}
                    {isMobileProfileOpen && (
                        <div className="fixed inset-0 z-70 md:hidden lg:hidden flex items-end">
                            <div className="absolute inset-0 bg-black/40" onClick={() => setIsMobileProfileOpen(false)} />
                            <div className="relative w-full bg-white rounded-t-xl p-4 shadow-xl">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center space-x-3">
                                        <img src={currentUser?.avatar} alt="avatar" className="w-12 h-12 rounded-full" />
                                        <div>
                                            <div className="font-medium text-slate-900">{currentUser?.name}</div>
                                            <div className="text-xs text-slate-500">{currentUser?.role}</div>
                                        </div>
                                    </div>
                                    <button onClick={() => setIsMobileProfileOpen(false)} className="text-slate-500">Close</button>
                                </div>

                                <div className="mt-4 space-y-3">
                                    <button onClick={() => { setIsAvatarModalOpen(true); setIsMobileProfileOpen(false); }} className="w-full text-left px-4 py-2 bg-slate-50 rounded-lg flex items-center space-x-3">
                                        <Icons.Image size={18} />
                                        <span>Change Avatar</span>
                                    </button>

                                    <button onClick={() => { setIsMobileProfileOpen(false); handleLogout(); }} className="w-full text-left px-4 py-2 bg-rose-50 text-rose-600 rounded-lg flex items-center space-x-3">
                                        <Icons.LogOut size={18} />
                                        <span>Logout</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {isProjectModalOpen && (
                        <ProjectModal 
                            onClose={() => setIsProjectModalOpen(false)}
                            onSave={handleCreateProject}
                            ownerId={currentUser.id}
                        />
                    )}

                    {editingSubtaskDetails && currentProject && (
                        <SubtaskModal
                            isOpen={!!editingSubtaskDetails}
                            onClose={() => setEditingSubtaskDetails(null)}
                            onSave={handleSaveSubtask}
                            task={tasks.find(t => t.id === editingSubtaskDetails.taskId)} 
                            subtask={editingSubtaskDetails.subtask}
                            users={allUsers}
                            currentUser={currentUser}
                            canWrite={canModifyTask}
                            mode={editingSubtaskDetails.mode}
                        />
                    )}
                    {isManageAccessOpen && manageAccessProject && (
                        <ManageAccessModal
                            isOpen={isManageAccessOpen}
                            onClose={() => setIsManageAccessOpen(false)}
                            project={manageAccessProject}
                            users={allUsers}
                            onSave={handleSaveProjectAccess}
                        />
                    )}

                    {/* Incoming call UI */}
                    {incomingCall && (
                        <IncomingCallModal
                            callData={incomingCall}
                            onAccept={acceptIncomingCall}
                            onDecline={declineIncomingCall}
                        />
                    )}

                    {/* Call UI / Remote audio element */}
                    <CallModal
                        isCalling={isCalling}
                        isInCall={isInCall}
                        targetUser={allUsers.find(u => u.id === callTargetId)}
                        onHangup={endCallLocal}
                        onToggleMute={toggleMute}
                        muted={muted}
                        audioRef={audioRef}
                        remoteStreamRef={remoteStreamRef}
                        remoteAudioUrl={remoteAudioUrl}
                        microphones={microphones}
                        speakers={speakers}
                        selectedMicId={selectedMicId}
                        selectedSpeakerId={selectedSpeakerId}
                        onChangeMic={changeMicrophone}
                        onChangeSpeaker={changeSpeaker}
                        callStartTime={callStartTime}
                    />
                    {isAvatarModalOpen && (
                        <AvatarModal
                            isOpen={isAvatarModalOpen}
                            onClose={() => setIsAvatarModalOpen(false)}
                            currentUser={currentUser}
                            onSave={handleSaveAvatar}
                        />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
</html>
